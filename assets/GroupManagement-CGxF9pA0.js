import{e as W,s as c,v as p,w as o,P as me,y as ve,E as t,D as l,F as s,$ as P,J as y,K as h,I as E,H as S,Q as L,Y as fe,Z as R,a1 as ye,T as be,U as q,r as w,a0 as _e,j as D,a2 as I,a3 as xe,G as x,S as he,a4 as b,h as ge,a5 as H,_ as we}from"./index-BsKuKuBe.js";import{u as ke}from"./composables-FnfCle_S.js";import{S as Ne,A as Ee,E as Se,N as De,D as Ie}from"./SearchOutlined-6trNpiHj.js";import{N as B}from"./Spin-D6NC1_9t.js";import{N as Ce,a as Me}from"./DrawerContent-Dys-I5Rb.js";import{N as J}from"./Empty-DtuLCoXR.js";import{N as C}from"./Icon-CbayTH31.js";import{N as K}from"./Space-Cf9Hs1lp.js";import{N as Q}from"./Tag-I3_cH6qL.js";import{N as ze}from"./Switch-DXNn_bI_.js";import{N as Ae}from"./RadioGroup-CgIVku-C.js";import{N as $}from"./RadioButton-Bm_8G4Bh.js";import"./Popover-CfBNgOAF.js";import"./use-compitable-BjMNwQgq.js";const Pe={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 24 24"},Ge=W({name:"GroupOutlined",render:function(T,M){return c(),p("svg",Pe,M[0]||(M[0]=[o("path",{d:"M9 13.75c-2.34 0-7 1.17-7 3.5V19h14v-1.75c0-2.33-4.66-3.5-7-3.5zM4.34 17c.84-.58 2.87-1.25 4.66-1.25s3.82.67 4.66 1.25H4.34zM9 12c1.93 0 3.5-1.57 3.5-3.5S10.93 5 9 5S5.5 6.57 5.5 8.5S7.07 12 9 12zm0-5c.83 0 1.5.67 1.5 1.5S9.83 10 9 10s-1.5-.67-1.5-1.5S8.17 7 9 7zm7.04 6.81c1.16.84 1.96 1.96 1.96 3.44V19h4v-1.75c0-2.02-3.5-3.17-5.96-3.44zM15 12c1.93 0 3.5-1.57 3.5-3.5S16.93 5 15 5c-.54 0-1.04.13-1.5.35c.63.89 1 1.98 1 3.15s-.37 2.26-1 3.15c.46.22.96.35 1.5.35z",fill:"currentColor"},null,-1)]))}}),Ue={class:"p-6 space-y-4"},Le={class:"flex justify-between items-center"},Re={class:"overflow-x-auto"},Be={class:"min-w-full border-collapse border border-gray-300"},$e={class:"border border-gray-300 px-4 py-2"},Te={class:"font-semibold"},je={class:"border border-gray-300 px-4 py-2"},Fe={class:"border border-gray-300 px-4 py-2 text-center"},Ve={class:"border border-gray-300 px-4 py-2"},Oe={class:"border border-gray-300 px-4 py-2 text-center"},qe={class:"border border-gray-300 px-4 py-2 text-center"},He={class:"space-y-3"},Je={class:"flex justify-between items-center mb-2"},Ke={class:"font-semibold text-gray-900"},Qe={class:"space-y-2 ml-3"},We={class:"text-sm"},Ye={class:"space-y-2"},Ze={key:0,class:"p-4"},Xe={key:1,class:"space-y-2 max-h-60 overflow-y-auto"},es={class:"font-semibold text-sm"},ss={class:"text-xs text-gray-600"},ts={key:0,class:"p-4"},as={key:1,class:"space-y-2 max-h-60 overflow-y-auto"},ls={class:"font-semibold text-sm"},rs={class:"text-xs text-gray-600"},os=W({__name:"GroupManagement",setup(Y){const T=Se,M=Ie,Z=Ge,X=Ee,ee=Ne,v=me(),se=ke(),_=ve(),u=w([...xe]),m=w(!1),z=w(""),g=w(!1),G=w(!1),N=w(null),f=w(null),n=_e({name:"",description:"",permissions:{},sensitivePermissions:{}}),j=D(()=>{var r;return((r=_.user)==null?void 0:r.role)==="MANAGER"?H.filter(e=>e.module!=="1. 系統設定"):H}),U=D(()=>{const r=new Map;return j.value.forEach(e=>{r.has(e.module)||r.set(e.module,{label:e.module,key:e.module,disabled:!0,children:[]}),r.get(e.module).children.push({label:`${e.code} - ${e.name}`,key:e.code,prefix:()=>ge(Q,{size:"small",type:"info"},{default:()=>e.level})})}),Array.from(r.values())}),te=D(()=>{if(!z.value)return u.value;const r=z.value.toLowerCase();return u.value.filter(e=>{var i;return e.name.toLowerCase().includes(r)||((i=e.description)==null?void 0:i.toLowerCase().includes(r))})}),ae=()=>{N.value=null,n.name="",n.description="",j.value.forEach(r=>{n.permissions[r.code]="NONE"}),n.sensitivePermissions={},U.value.forEach(r=>{n.sensitivePermissions[r.key]=!1}),g.value=!0},le=r=>{N.value=r.id,n.name=r.name,n.description=r.description||"",n.permissions={...r.permissions},n.sensitivePermissions={...r.sensitive_permissions||{}},U.value.forEach(e=>{n.sensitivePermissions[e.key]===void 0&&(n.sensitivePermissions[e.key]=!1)}),g.value=!0},re=async()=>{var r,e,i;try{if(!n.name.trim()){v.error("群組名稱不可為空");return}if(u.value.some(d=>d.name===n.name&&d.id!==N.value)){v.error("群組名稱已存在");return}if(m.value=!0,await I(),N.value){const d=u.value.findIndex(k=>k.id===N.value);d!==-1&&(u.value[d]={...u.value[d],name:n.name,description:n.description,permissions:n.permissions,sensitive_permissions:n.sensitivePermissions,updated_by:((r=_.user)==null?void 0:r.user_id)||"admin",updated_at:new Date().toLocaleString()},v.success("群組更新成功"))}else{const d={id:`group-${Date.now()}`,name:n.name,description:n.description,permissions:n.permissions,sensitive_permissions:n.sensitivePermissions,member_count:0,status:"ENABLED",created_by:((e=_.user)==null?void 0:e.user_id)||"admin",created_at:new Date().toLocaleString(),updated_by:((i=_.user)==null?void 0:i.user_id)||"admin",updated_at:new Date().toLocaleString()};u.value.push(d),v.success("群組建立成功")}g.value=!1}catch{v.error("保存失敗")}finally{m.value=!1}},oe=async r=>{var e;if(r.member_count>0){se.warning({title:"無法刪除",content:`該群組尚有 ${r.member_count} 個管理員使用中，無法刪除`,positiveText:"確定",onPositiveClick:()=>{}});return}try{m.value=!0,await I();const i=u.value.findIndex(a=>a.id===r.id);i!==-1&&(u.value[i].deleted_at=new Date().toLocaleString(),u.value[i].deleted_by=((e=_.user)==null?void 0:e.user_id)||"admin",u.value.splice(i,1)),v.success("群組已刪除")}catch{v.error("刪除失敗")}finally{m.value=!1}},ie=r=>{f.value=r,G.value=!0},ne=async r=>{try{m.value=!0,await I();const e=u.value.findIndex(i=>i.id===r.id);if(e!==-1){const i=r.status==="ENABLED"?"DISABLED":"ENABLED";u.value[e].status=i,v.success(i==="ENABLED"?"群組已啟用":"群組已停用")}}catch{v.error("狀態更新失敗")}finally{m.value=!1}},de=()=>f.value?b.filter(r=>{var e;return(e=r.groups)==null?void 0:e.includes(f.value.id)}):[],ue=()=>{if(!f.value)return[];const r=b.filter(e=>{var i;return(i=e.groups)==null?void 0:i.includes(f.value.id)}).map(e=>e.id);return b.filter(e=>e.role==="USER"&&!r.includes(e.id)&&!e.deleted_at&&e.status!=="DISABLED")},F=D(()=>ue()),V=D(()=>de()),ce=async r=>{try{if(m.value=!0,await I(),f.value){const e=b.findIndex(a=>a.id===r);e!==-1&&b[e].groups&&(b[e].groups=b[e].groups.filter(a=>a!==f.value.id));const i=u.value.findIndex(a=>a.id===f.value.id);i!==-1&&(u.value[i].member_count=Math.max(0,u.value[i].member_count-1)),v.success("成員已移除")}}catch{v.error("移除失敗")}finally{m.value=!1}},pe=async r=>{try{if(m.value=!0,await I(),f.value){const e=b.findIndex(i=>i.id===r);if(e!==-1){b[e].groups||(b[e].groups=[]),b[e].groups.push(f.value.id);const i=u.value.findIndex(a=>a.id===f.value.id);i!==-1&&(u.value[i].member_count+=1),v.success("成員已加入")}}}catch{v.error("加入失敗")}finally{m.value=!1}};return(r,e)=>{var i;return c(),p("div",Ue,[e[17]||(e[17]=o("div",null,[o("h1",{class:"text-3xl font-bold text-gray-900"},"群組管理"),o("p",{class:"text-gray-600 mt-1"},"管理權限群組，為一般職員分配功能權限")],-1)),o("div",Le,[t(s(P),{value:z.value,"onUpdate:value":e[0]||(e[0]=a=>z.value=a),type:"text",placeholder:"搜尋群組名稱或描述...",clearable:"",style:{"max-width":"300px"}},{prefix:l(()=>[t(s(C),null,{default:l(()=>[t(s(ee))]),_:1})]),_:1},8,["value"]),t(s(h),{type:"primary",disabled:((i=s(_).user)==null?void 0:i.role)==="USER",onClick:ae},{icon:l(()=>[t(s(C),null,{default:l(()=>[t(s(X))]),_:1})]),default:l(()=>[e[6]||(e[6]=y(" 新增群組 ",-1))]),_:1},8,["disabled"])]),t(s(L),{bordered:!1},{default:l(()=>[t(s(B),{show:m.value},{default:l(()=>[o("div",Re,[o("table",Be,[e[8]||(e[8]=o("thead",{class:"bg-gray-50"},[o("tr",null,[o("th",{class:"border border-gray-300 px-4 py-2 text-left"},"群組名稱"),o("th",{class:"border border-gray-300 px-4 py-2 text-left"},"群組描述"),o("th",{class:"border border-gray-300 px-4 py-2 text-center"},"成員數"),o("th",{class:"border border-gray-300 px-4 py-2 text-left"},"操作人"),o("th",{class:"border border-gray-300 px-4 py-2 text-center"},"狀態"),o("th",{class:"border border-gray-300 px-4 py-2 text-center"},"操作")])],-1)),o("tbody",null,[(c(!0),p(E,null,S(te.value,a=>{var d;return c(),p("tr",{key:a.id,class:"border border-gray-300 hover:bg-gray-50"},[o("td",$e,[o("span",Te,x(a.name),1)]),o("td",je,x(a.description||"-"),1),o("td",Fe,[t(s(Q),{type:"info",round:""},{default:l(()=>[y(x(a.member_count),1)]),_:2},1024)]),o("td",Ve,x(a.updated_by||"-"),1),o("td",Oe,[t(s(ze),{value:a.status==="ENABLED","onUpdate:value":()=>ne(a),disabled:((d=s(_).user)==null?void 0:d.role)==="USER"},null,8,["value","onUpdate:value","disabled"])]),o("td",qe,[t(s(K),{justify:"center",size:8},{default:l(()=>{var k,O;return[t(s(h),{text:"",type:"primary",size:"small",disabled:((k=s(_).user)==null?void 0:k.role)==="USER",onClick:A=>le(a)},{icon:l(()=>[t(s(C),{size:"18"},{default:l(()=>[t(s(T))]),_:1})]),_:1},8,["disabled","onClick"]),t(s(h),{text:"",type:"info",size:"small",onClick:A=>ie(a)},{icon:l(()=>[t(s(C),{size:"18"},{default:l(()=>[t(s(Z))]),_:1})]),_:1},8,["onClick"]),t(s(De),{disabled:((O=s(_).user)==null?void 0:O.role)==="USER"||a.member_count>0,onPositiveClick:()=>oe(a)},{trigger:l(()=>{var A;return[t(s(h),{text:"",type:"error",size:"small",disabled:((A=s(_).user)==null?void 0:A.role)==="USER"},{icon:l(()=>[t(s(C),{size:"18"},{default:l(()=>[t(s(M))]),_:1})]),_:1},8,["disabled"])]}),default:l(()=>[e[7]||(e[7]=y(" 確定要刪除此群組嗎？ ",-1))]),_:1},8,["disabled","onPositiveClick"])]}),_:2},1024)])])}),128))])])])]),_:1},8,["show"])]),_:1}),t(s(ye),{show:g.value,"onUpdate:show":e[4]||(e[4]=a=>g.value=a),title:"群組設定",preset:"dialog",size:"large","on-close":()=>g.value=!1},{action:l(()=>[t(s(K),null,{default:l(()=>[t(s(h),{onClick:e[3]||(e[3]=()=>g.value=!1)},{default:l(()=>[...e[13]||(e[13]=[y("取消",-1)])]),_:1}),t(s(h),{type:"primary",loading:m.value,onClick:re},{default:l(()=>[...e[14]||(e[14]=[y(" 保存 ",-1)])]),_:1},8,["loading"])]),_:1})]),default:l(()=>[t(s(B),{show:m.value},{default:l(()=>[t(s(fe),{ref:"groupFormRef",model:n,"label-placement":"top","label-width":"auto"},{default:l(()=>[t(s(R),{label:"群組名稱",path:"name",required:""},{default:l(()=>[t(s(P),{value:n.name,"onUpdate:value":e[1]||(e[1]=a=>n.name=a),placeholder:"請輸入群組名稱",maxlength:"50"},null,8,["value"])]),_:1}),t(s(R),{label:"群組描述",path:"description"},{default:l(()=>[t(s(P),{value:n.description,"onUpdate:value":e[2]||(e[2]=a=>n.description=a),type:"textarea",placeholder:"請輸入群組描述",maxlength:"200",rows:3},null,8,["value"])]),_:1}),t(s(R),{label:"功能權限",required:""},{default:l(()=>[o("div",He,[(c(!0),p(E,null,S(U.value,a=>(c(),p("div",{key:a.key,class:"border rounded p-3 bg-gray-50"},[o("div",Je,[o("p",Ke,x(a.label),1),t(s(he),{checked:n.sensitivePermissions[a.key],"onUpdate:checked":d=>n.sensitivePermissions[a.key]=d},{default:l(()=>[...e[9]||(e[9]=[y(" 敏感資料 ",-1)])]),_:1},8,["checked","onUpdate:checked"])]),o("div",Qe,[(c(!0),p(E,null,S(a.children,d=>(c(),p("div",{key:d.key,class:"flex items-center justify-between p-2 bg-white rounded border border-gray-200 hover:bg-blue-50"},[o("span",We,x(d.label),1),t(s(Ae),{value:n.permissions[d.key],"onUpdate:value":k=>n.permissions[d.key]=k,size:"small"},{default:l(()=>[t(s($),{value:"NONE"},{default:l(()=>[...e[10]||(e[10]=[y("無",-1)])]),_:1}),t(s($),{value:"READ"},{default:l(()=>[...e[11]||(e[11]=[y("唯讀",-1)])]),_:1}),t(s($),{value:"WRITE"},{default:l(()=>[...e[12]||(e[12]=[y("操作",-1)])]),_:1})]),_:1},8,["value","onUpdate:value"])]))),128))])]))),128))])]),_:1})]),_:1},8,["model"])]),_:1},8,["show"])]),_:1},8,["show","on-close"]),t(s(Me),{show:G.value,"onUpdate:show":e[5]||(e[5]=a=>G.value=a),title:"成員管理",width:"500",placement:"right"},{default:l(()=>[t(s(Ce),null,{default:l(()=>[t(s(B),{show:m.value},{default:l(()=>[t(s(be),{cols:1,responsive:"screen","x-gap":12,"y-gap":12},{default:l(()=>[t(s(q),null,{default:l(()=>[t(s(L),{title:"可加入成員",size:"small"},{default:l(()=>[o("div",Ye,[t(s(P),{ref:"searchMemberRef",type:"text",placeholder:"搜尋帳號或名稱...",clearable:""},null,512),F.value.length===0?(c(),p("div",Ze,[t(s(J),{description:"無可加入的成員"})])):(c(),p("div",Xe,[(c(!0),p(E,null,S(F.value,a=>(c(),p("div",{key:a.id,class:"flex items-center justify-between p-3 border rounded bg-gray-50 hover:bg-gray-100"},[o("div",null,[o("p",es,x(a.display_name),1),o("p",ss,"@"+x(a.username),1)]),t(s(h),{type:"primary",size:"small",onClick:d=>pe(a.id)},{default:l(()=>[...e[15]||(e[15]=[y(" 加入 ",-1)])]),_:1},8,["onClick"])]))),128))]))])]),_:1})]),_:1}),t(s(q),null,{default:l(()=>[t(s(L),{title:"已加入成員",size:"small"},{default:l(()=>[V.value.length===0?(c(),p("div",ts,[t(s(J),{description:"暫無成員"})])):(c(),p("div",as,[(c(!0),p(E,null,S(V.value,a=>(c(),p("div",{key:a.id,class:"flex items-center justify-between p-3 border rounded bg-blue-50"},[o("div",null,[o("p",ls,x(a.display_name),1),o("p",rs," @"+x(a.username),1)]),t(s(h),{type:"error",size:"small",onClick:d=>ce(a.id)},{default:l(()=>[...e[16]||(e[16]=[y(" 移除 ",-1)])]),_:1},8,["onClick"])]))),128))]))]),_:1})]),_:1})]),_:1})]),_:1},8,["show"])]),_:1})]),_:1},8,["show"])])}}}),gs=we(os,[["__scopeId","data-v-06e3680d"]]);export{gs as default};
