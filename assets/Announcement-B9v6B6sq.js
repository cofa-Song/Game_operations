import{e as he,A as we,P as Ne,a0 as G,r as M,h as x,K as I,o as Me,v as V,E as o,D as i,F as t,w as N,J as $,G as f,W as _e,Q as ne,$ as Y,a1 as ae,Y as xe,T as Ee,U as O,Z as C,a8 as Ae,I as Se,H as be,j as le,s as q,S as Ue,_ as Ie}from"./index-BsKuKuBe.js";import{u as Oe}from"./composables-FnfCle_S.js";import{N as se}from"./Tag-I3_cH6qL.js";import{N as Z}from"./Space-Cf9Hs1lp.js";import{N as oe}from"./InputNumber-BMu_ZOnr.js";import{N as ie}from"./Switch-DXNn_bI_.js";import{N as K}from"./Select-CCDzjsmj.js";import{N as ue}from"./DatePicker-CVYfnur-.js";import{N as Ce}from"./DataTable-D5mRR0cm.js";import"./Add-BJRbFrfV.js";import"./Popover-CfBNgOAF.js";import"./use-compitable-BjMNwQgq.js";import"./create-Bj8PAPmY.js";import"./Empty-DtuLCoXR.js";import"./use-keyboard-kkRvbDTj.js";import"./Forward-CBwL8ab_.js";import"./Radio-C5fS5KPL.js";import"./RadioGroup-CgIVku-C.js";import"./Tooltip-XZFA5Owl.js";import"./Dropdown-CcmdnIk3.js";import"./Icon-CbayTH31.js";import"./create-ref-setter-C4J8sofl.js";import"./Pagination-BLbp2o8H.js";var m=(s=>(s.MARQUEE="MARQUEE",s.SYSTEM_NOTIFICATION="SYSTEM_NOTIFICATION",s.OPERATION_ANNOUNCEMENT="OPERATION_ANNOUNCEMENT",s))(m||{}),c=(s=>(s.ZH_TW="zh-TW",s.ZH_CN="zh-CN",s.EN="en",s.ALL="all",s))(c||{});const v=[{id:"1",type:m.MARQUEE,title:"歡迎來到遊戲平台！",languages:[c.ZH_TW,c.ZH_CN,c.EN],content:"祝各位玩家遊戲愉快，好運連連！",jumpUrl:"",startTime:"2024-01-01T00:00:00Z",endTime:"2025-12-31T23:59:59Z",weight:10,statusTest:!0,statusLive:!0,lastModifiedAt:"2024-01-01T12:00:00Z",lastModifiedBy:"admin"},{id:"2",type:m.SYSTEM_NOTIFICATION,title:"系統維護公告",languages:[c.ZH_TW],content:"將於凌晨 2:00 進行維護，預計耗時 2 小時。",jumpUrl:"/maintenance",startTime:"2024-02-01T02:00:00Z",endTime:"2024-02-01T04:00:00Z",weight:1,statusTest:!0,statusLive:!1,lastModifiedAt:"2024-01-31T18:00:00Z",lastModifiedBy:"system"},{id:"3",type:m.OPERATION_ANNOUNCEMENT,title:"春節限時活動",languages:[c.ZH_TW,c.ZH_CN],content:"<b>春節大特賣！</b> 儲值就送 50% 額外獎金。",jumpUrl:"https://example.com/cny",startTime:"2024-02-05T00:00:00Z",endTime:"2024-02-15T23:59:59Z",weight:5,statusTest:!0,statusLive:!0,lastModifiedAt:"2024-02-01T09:00:00Z",lastModifiedBy:"op_manager"}],R=500,z=s=>new Promise(e=>setTimeout(e,s)),P={async getAnnouncements(s){await z(R);let e=[...v];if(s.types&&s.types.length>0&&(e=e.filter(r=>s.types.includes(r.type))),s.title&&(e=e.filter(r=>r.title.toLowerCase().includes(s.title.toLowerCase()))),s.languages&&s.languages.length>0&&(e=e.filter(r=>s.languages.some(T=>r.languages.includes(T)))),s.startTime){const r=new Date(s.startTime).getTime();e=e.filter(T=>new Date(T.startTime).getTime()>=r)}if(s.endTime){const r=new Date(s.endTime).getTime();e=e.filter(T=>new Date(T.endTime).getTime()<=r)}e.sort((r,T)=>r.weight!==T.weight?r.weight-T.weight:new Date(T.startTime).getTime()-new Date(r.startTime).getTime());const d=e.length,p=(s.page-1)*s.pageSize,y=p+s.pageSize;return{code:0,msg:"success",data:{items:e.slice(p,y),total:d,page:s.page,pageSize:s.pageSize}}},async createAnnouncement(s){await z(R);const e={...s,id:Math.random().toString(36).substr(2,9),jumpUrl:s.jumpUrl||"",statusTest:!1,statusLive:!1,lastModifiedAt:new Date().toISOString(),lastModifiedBy:"admin"};return v.unshift(e),{code:0,msg:"success",data:e}},async updateAnnouncement(s,e){await z(R);const d=v.findIndex(p=>p.id===s);return d===-1?{code:404,msg:"Not found"}:(v[d]={...v[d],...e,lastModifiedAt:new Date().toISOString(),lastModifiedBy:"admin"},{code:0,msg:"success"})},async deleteAnnouncement(s){await z(R);const e=v.findIndex(d=>d.id===s);return e===-1?{code:404,msg:"Not found"}:(v.splice(e,1),{code:0,msg:"success"})},async toggleStatus(s,e,d){await z(R);const p=v.findIndex(y=>y.id===s);return p===-1?{code:404,msg:"Not found"}:(e==="test"?v[p].statusTest=d:v[p].statusLive=d,v[p].lastModifiedAt=new Date().toISOString(),v[p].lastModifiedBy="admin",console.log(`[Cache] Updating Announcement_Cache_Key for ${s}`),{code:0,msg:"success"})}},De={class:"p-4"},ke={class:"flex gap-2"},$e={key:0,class:"ml-1"},He={class:"flex flex-col gap-1"},Ze={class:"text-xs text-gray-500"},Re={class:"flex flex-col gap-1"},ze={class:"text-xs text-gray-500"},Pe={class:"flex flex-col gap-1"},je={class:"text-xs text-gray-500"},Le={class:"flex flex-col gap-1"},Fe={class:"text-xs text-gray-500"},Be={class:"text-xs text-gray-400"},Qe={class:"flex justify-end gap-3 mt-6"},Ye=he({__name:"Announcement",setup(s){const{t:e}=we(),d=Ne(),p=Oe(),y=(n,a="yyyy-MM-dd HH:mm")=>{const l=new Date(n);if(isNaN(l.getTime()))return"";const w=Te=>Te.toString().padStart(2,"0"),g=l.getFullYear(),_=w(l.getMonth()+1),A=w(l.getDate()),B=w(l.getHours()),Q=w(l.getMinutes()),te=w(l.getSeconds());return a==="yyyy-MM-dd HH:mm:ss"?`${g}-${_}-${A} ${B}:${Q}:${te}`:a==="yyyy-MM-dd HH:mm"?`${g}-${_}-${A} ${B}:${Q}`:a==="yyyy-MM-dd'T'HH:mm:ss'Z'"?`${g}-${_}-${A}T${B}:${Q}:${te}Z`:`${g}-${_}-${A} ${B}:${Q}`},S=M(!1),r=M([]),T=M(0),b=G({page:1,pageSize:10,showSizePicker:!0,pageSizes:[10,20,50],onChange:n=>{b.page=n,E()},onUpdatePageSize:n=>{b.pageSize=n,b.page=1,E()}}),h=G({types:[],title:"",languages:[],startTime:void 0,endTime:void 0}),H=M(null),J=[{label:e("announcement.types.MARQUEE"),value:m.MARQUEE},{label:e("announcement.types.SYSTEM_NOTIFICATION"),value:m.SYSTEM_NOTIFICATION},{label:e("announcement.types.OPERATION_ANNOUNCEMENT"),value:m.OPERATION_ANNOUNCEMENT}],W=[{label:e("common.all"),value:c.ALL},{label:"繁體中文",value:c.ZH_TW},{label:"简体中文",value:c.ZH_CN},{label:"English",value:c.EN}],U=M(!1),j=M("add"),L=M(null),u=G({type:m.MARQUEE,title:"",languages:[c.ZH_TW],content:"",jumpUrl:"",startTime:y(new Date,"yyyy-MM-dd'T'HH:mm:ss'Z'"),endTime:y(new Date(Date.now()+7*24*60*60*1e3),"yyyy-MM-dd'T'HH:mm:ss'Z'"),weight:1}),D=M([new Date().getTime(),new Date(Date.now()+7*24*60*60*1e3).getTime()]),de=le(()=>u.type===m.MARQUEE?e("announcement.marqueeLimit"):"支援 HTML 標籤"),E=async()=>{S.value=!0;try{const n=await P.getAnnouncements({...h,page:b.page,pageSize:b.pageSize});n.code===0&&n.data&&(r.value=n.data.items,T.value=n.data.total)}catch{d.error(e("common.loadFailed"))}finally{S.value=!1}},re=()=>{H.value?(h.startTime=new Date(H.value[0]).toISOString(),h.endTime=new Date(H.value[1]).toISOString()):(h.startTime=void 0,h.endTime=void 0),b.page=1,E()},me=()=>{j.value="add",L.value=null,Object.assign(u,{type:m.MARQUEE,title:"",languages:[c.ZH_TW],content:"",jumpUrl:"",startTime:y(new Date,"yyyy-MM-dd'T'HH:mm:ss'Z'"),endTime:y(new Date(Date.now()+7*24*60*60*1e3),"yyyy-MM-dd'T'HH:mm:ss'Z'"),weight:1}),D.value=[new Date().getTime(),new Date(Date.now()+7*24*60*60*1e3).getTime()],U.value=!0},ce=n=>{j.value="edit",L.value=n.id,Object.assign(u,{type:n.type,title:n.title,languages:[...n.languages],content:n.content,jumpUrl:n.jumpUrl||"",startTime:n.startTime,endTime:n.endTime,weight:n.weight}),D.value=[new Date(n.startTime).getTime(),new Date(n.endTime).getTime()],U.value=!0},pe=n=>{p.warning({title:e("common.warning"),content:e("announcement.deleteConfirm"),positiveText:e("common.confirm"),negativeText:e("common.cancel"),onPositiveClick:async()=>{try{(await P.deleteAnnouncement(n)).code===0&&(d.success(e("announcement.deleteSuccess")),E())}catch{d.error(e("common.error"))}}})},ge=async()=>{u.startTime=new Date(D.value[0]).toISOString(),u.endTime=new Date(D.value[1]).toISOString();try{j.value==="add"?(await P.createAnnouncement(u)).code===0&&(d.success(e("announcement.addSuccess")),U.value=!1,E()):L.value&&(await P.updateAnnouncement(L.value,u)).code===0&&(d.success(e("announcement.updateSuccess")),U.value=!1,E())}catch{d.error(e("common.error"))}},k=M({}),X=le(()=>Object.keys(k.value).length>0),F=M(!1),fe=(n,a)=>{k.value[`${n}_weight`]={field:"weight",value:a}},ee=(n,a,l)=>{k.value[`${n}_${a}`]={field:a==="test"?"statusTest":"statusLive",value:l}},ve=async()=>{S.value=!0;try{const n=new Map;Object.entries(k.value).forEach(([g,_])=>{const A=g.split("_")[0];n.has(A)||n.set(A,{}),n.get(A)[_.field]=_.value});const a=Array.from(n.entries()).map(([g,_])=>P.updateAnnouncement(g,_)),l=await Promise.all(a),w=l.filter(g=>g.code===0).length;w===l.length?d.success(e("common.success")):d.warning(`部分存取失敗 (${w}/${l.length})`),F.value=!1,k.value={},E()}catch{d.error(e("common.error"))}finally{S.value=!1}},ye=[{title:e("announcement.type"),key:"type",width:120,render(n){const l={[m.MARQUEE]:{type:"info",label:e("announcement.types.MARQUEE")},[m.SYSTEM_NOTIFICATION]:{type:"success",label:e("announcement.types.SYSTEM_NOTIFICATION")},[m.OPERATION_ANNOUNCEMENT]:{type:"warning",label:e("announcement.types.OPERATION_ANNOUNCEMENT")}}[n.type];return x(se,{type:l.type,bordered:!1},{default:()=>l.label})}},{title:e("announcement.announcementTitle"),key:"title",width:200,ellipsis:{tooltip:!0}},{title:e("announcement.languages"),key:"languages",width:150,render(n){return x(Z,{size:4},{default:()=>n.languages.map(a=>{var w;const l=((w=W.find(g=>g.value===a))==null?void 0:w.label)||a;return x(se,{size:"small",bordered:!1},{default:()=>l})})})}},{title:e("announcement.weight"),key:"weight",width:100,render(n){return x(oe,{size:"small",value:n.weight,min:1,max:999,"onUpdate:value":a=>{a&&(n.weight=a,fe(n.id,a))}})}},{title:e("announcement.publishInterval"),key:"interval",width:320,render(n){return`${y(n.startTime)} - ${y(n.endTime)}`}},{title:e("announcement.lastModified"),key:"lastModifiedAt",width:160,render(n){return y(n.lastModifiedAt)}},{title:e("announcement.operator"),key:"lastModifiedBy",width:100},{title:e("announcement.statusTest"),key:"statusTest",width:120,render(n){return x(ie,{value:n.statusTest,"onUpdate:value":a=>{n.statusTest=a,ee(n.id,"test",a)}})}},{title:e("announcement.statusLive"),key:"statusLive",width:120,render(n){return x(ie,{value:n.statusLive,"onUpdate:value":a=>{n.statusLive=a,ee(n.id,"live",a)}})}},{title:e("common.action"),key:"actions",width:120,fixed:"right",render(n){return x(Z,null,{default:()=>[x(I,{size:"small",onClick:()=>ce(n)},{default:()=>e("common.edit")}),x(I,{size:"small",type:"error",ghost:!0,onClick:()=>pe(n.id)},{default:()=>e("common.delete")})]})}}];return Me(E),(n,a)=>(q(),V("div",De,[o(t(ne),{title:t(e)("announcement.title"),class:"shadow-sm rounded-lg border-none"},{"header-extra":i(()=>[o(t(I),{type:"info",onClick:me},{default:i(()=>[$(f(t(e)("common.add")),1)]),_:1})]),default:i(()=>[o(t(Z),{vertical:"",size:"large"},{default:i(()=>[N("div",ke,[o(t(I),{type:"warning",disabled:!X.value,onClick:a[0]||(a[0]=l=>F.value=!0),loading:S.value},{default:i(()=>[$(f(t(e)("game.list.accessOperation"))+" ",1),X.value?(q(),V("span",$e,"("+f(Object.keys(k.value).length)+")",1)):_e("",!0)]),_:1},8,["disabled","loading"])]),o(t(ne),{embedded:"",bordered:!1,size:"small"},{default:i(()=>[o(t(Z),{align:"end",wrap:""},{default:i(()=>[N("div",He,[N("span",Ze,f(t(e)("announcement.type")),1),o(t(K),{value:h.types,"onUpdate:value":a[1]||(a[1]=l=>h.types=l),multiple:"",options:J,placeholder:t(e)("common.all"),style:{width:"240px"}},null,8,["value","placeholder"])]),N("div",Re,[N("span",ze,f(t(e)("announcement.announcementTitle")),1),o(t(Y),{value:h.title,"onUpdate:value":a[2]||(a[2]=l=>h.title=l),placeholder:t(e)("common.keywordPlaceholder"),clearable:"",style:{width:"200px"}},null,8,["value","placeholder"])]),N("div",Pe,[N("span",je,f(t(e)("announcement.languages")),1),o(t(K),{value:h.languages,"onUpdate:value":a[3]||(a[3]=l=>h.languages=l),multiple:"",options:W,placeholder:t(e)("common.all"),style:{width:"200px"}},null,8,["value","placeholder"])]),N("div",Le,[N("span",Fe,f(t(e)("announcement.publishInterval")),1),o(t(ue),{value:H.value,"onUpdate:value":a[4]||(a[4]=l=>H.value=l),type:"datetimerange",clearable:"",style:{width:"380px"}},null,8,["value"])]),o(t(I),{type:"primary",onClick:re},{default:i(()=>[$(f(t(e)("common.search")),1)]),_:1})]),_:1})]),_:1}),o(t(Ce),{remote:"",loading:S.value,columns:ye,data:r.value,pagination:b,"row-key":l=>l.id,"scroll-x":"1600"},null,8,["loading","data","pagination","row-key"])]),_:1})]),_:1},8,["title"]),o(t(ae),{show:F.value,"onUpdate:show":a[5]||(a[5]=l=>F.value=l),preset:"dialog",type:"warning",title:t(e)("common.warning"),content:t(e)("game.list.saveConfirm"),"positive-text":t(e)("common.confirm"),"negative-text":t(e)("common.cancel"),onPositiveClick:ve},null,8,["show","title","content","positive-text","negative-text"]),o(t(ae),{show:U.value,"onUpdate:show":a[14]||(a[14]=l=>U.value=l),preset:"card",title:j.value==="add"?t(e)("common.add"):t(e)("common.edit"),style:{width:"800px"}},{default:i(()=>[o(t(xe),{model:u,"label-placement":"left","label-width":"120","require-mark-placement":"right-hanging"},{default:i(()=>[o(t(Ee),{cols:2,"x-gap":24},{default:i(()=>[o(t(O),{span:2},{default:i(()=>[o(t(C),{label:t(e)("announcement.type"),path:"type"},{default:i(()=>[o(t(K),{value:u.type,"onUpdate:value":a[6]||(a[6]=l=>u.type=l),options:J},null,8,["value"])]),_:1},8,["label"])]),_:1}),o(t(O),{span:2},{default:i(()=>[o(t(C),{label:t(e)("announcement.announcementTitle"),path:"title"},{default:i(()=>[o(t(Y),{value:u.title,"onUpdate:value":a[7]||(a[7]=l=>u.title=l),maxlength:50,"show-count":""},null,8,["value"])]),_:1},8,["label"])]),_:1}),o(t(O),{span:2},{default:i(()=>[o(t(C),{label:t(e)("announcement.languages"),path:"languages"},{default:i(()=>[o(t(Ae),{value:u.languages,"onUpdate:value":a[8]||(a[8]=l=>u.languages=l)},{default:i(()=>[o(t(Z),null,{default:i(()=>[(q(),V(Se,null,be(W,l=>o(t(Ue),{key:l.value,value:l.value},{default:i(()=>[$(f(l.label),1)]),_:2},1032,["value"])),64))]),_:1})]),_:1},8,["value"])]),_:1},8,["label"])]),_:1}),o(t(O),{span:2},{default:i(()=>[o(t(C),{label:t(e)("announcement.content"),path:"content"},{default:i(()=>[o(t(Y),{value:u.content,"onUpdate:value":a[9]||(a[9]=l=>u.content=l),type:"textarea",placeholder:de.value,autosize:{minRows:3,maxRows:6},maxlength:u.type===t(m).MARQUEE?200:void 0,"show-count":""},null,8,["value","placeholder","maxlength"])]),_:1},8,["label"])]),_:1}),o(t(O),{span:2},{default:i(()=>[o(t(C),{label:t(e)("announcement.jumpUrl"),path:"jumpUrl"},{default:i(()=>[o(t(Y),{value:u.jumpUrl,"onUpdate:value":a[10]||(a[10]=l=>u.jumpUrl=l),placeholder:"URL 或 APP 路徑"},null,8,["value"])]),_:1},8,["label"])]),_:1}),o(t(O),null,{default:i(()=>[o(t(C),{label:t(e)("announcement.weight"),path:"weight"},{feedback:i(()=>[N("span",Be,f(t(e)("announcement.weightTip")),1)]),default:i(()=>[o(t(oe),{value:u.weight,"onUpdate:value":a[11]||(a[11]=l=>u.weight=l),min:1,max:999},null,8,["value"])]),_:1},8,["label"])]),_:1}),o(t(O),{span:2},{default:i(()=>[o(t(C),{label:t(e)("announcement.publishInterval")},{default:i(()=>[o(t(ue),{value:D.value,"onUpdate:value":a[12]||(a[12]=l=>D.value=l),type:"datetimerange"},null,8,["value"])]),_:1},8,["label"])]),_:1})]),_:1}),N("div",Qe,[o(t(I),{onClick:a[13]||(a[13]=l=>U.value=!1)},{default:i(()=>[$(f(t(e)("common.cancel")),1)]),_:1}),o(t(I),{type:"primary",onClick:ge},{default:i(()=>[$(f(t(e)("common.confirm")),1)]),_:1})])]),_:1},8,["model"])]),_:1},8,["show","title"])]))}}),vt=Ie(Ye,[["__scopeId","data-v-a464d357"]]);export{vt as default};
