import{e as Te,A as Ne,P as _e,a0 as Z,r as v,h as I,K as U,o as xe,v as K,E as i,D as o,F as a,w as p,J as L,G as _,W as Ce,Q as ne,a1 as se,Y as Ie,T as Ue,U as E,Z as O,$ as ie,C as Se,j as De,s as G,_ as be}from"./index-BsKuKuBe.js";import{N as Me}from"./Upload-BfkJi9Os.js";import{u as Ee}from"./composables-FnfCle_S.js";import{N as Oe}from"./Tag-I3_cH6qL.js";import{N as $e}from"./Image--btsxYxc.js";import{N as le}from"./InputNumber-BMu_ZOnr.js";import{N as oe}from"./Switch-DXNn_bI_.js";import{N as W}from"./Space-Cf9Hs1lp.js";import{N as J}from"./Select-CCDzjsmj.js";import{N as re}from"./DatePicker-CVYfnur-.js";import{N as ke}from"./DataTable-D5mRR0cm.js";import"./Progress-DbyywU95.js";import"./Radio-C5fS5KPL.js";import"./RadioGroup-CgIVku-C.js";import"./Add-BJRbFrfV.js";import"./utils-pxpSiB-j.js";import"./Tooltip-XZFA5Owl.js";import"./Popover-CfBNgOAF.js";import"./use-compitable-BjMNwQgq.js";import"./create-Bj8PAPmY.js";import"./Empty-DtuLCoXR.js";import"./use-keyboard-kkRvbDTj.js";import"./Forward-CBwL8ab_.js";import"./Dropdown-CcmdnIk3.js";import"./Icon-CbayTH31.js";import"./create-ref-setter-C4J8sofl.js";import"./Pagination-BLbp2o8H.js";var h=(l=>(l.BANNER="BANNER",l.POPUP="POPUP",l))(h||{}),w=(l=>(l.EVERY_LOGIN="EVERY_LOGIN",l.DAILY_ONCE="DAILY_ONCE",l.ONCE_FOREVER="ONCE_FOREVER",l))(w||{});const P=500,F=l=>new Promise(e=>setTimeout(e,l)),j=new Date,Q=new Date(j.getFullYear()+1,j.getMonth(),j.getDate()).toISOString(),A=new Date(j.getTime()-24*60*60*1e3).toISOString(),Le=new Date(j.getTime()+24*60*60*1e3).toISOString(),g=[{id:"1",type:h.BANNER,title:"新春活動主 Banner",imageUrl:"https://via.placeholder.com/1920x450/FF0000/FFFFFF?text=CNY+Banner",jumpUrl:"/promotion/cny-2024",startTime:A,endTime:Q,weight:1,frequency:w.EVERY_LOGIN,statusTest:!0,statusLive:!0,lastModifiedAt:A,lastModifiedBy:"admin"},{id:"2",type:h.POPUP,title:"每日簽到提醒",imageUrl:"https://via.placeholder.com/600x600/0000FF/FFFFFF?text=Daily+Login",jumpUrl:"",startTime:A,endTime:Q,weight:10,frequency:w.DAILY_ONCE,statusTest:!0,statusLive:!1,lastModifiedAt:A,lastModifiedBy:"system"},{id:"3",type:h.BANNER,title:"VIP 專專屬優惠",imageUrl:"https://via.placeholder.com/1920x450/FFD700/000000?text=VIP+Banner",jumpUrl:"/vip",startTime:Le,endTime:Q,weight:2,frequency:w.EVERY_LOGIN,statusTest:!0,statusLive:!0,lastModifiedAt:A,lastModifiedBy:"admin"}],R={async getImageConfigs(l){await F(P);let e=[...g];if(l.types&&l.types.length>0&&(e=e.filter(c=>l.types.includes(c.type))),l.startTime){const c=new Date(l.startTime).getTime();e=e.filter(T=>new Date(T.startTime).getTime()>=c)}if(l.endTime){const c=new Date(l.endTime).getTime();e=e.filter(T=>new Date(T.endTime).getTime()<=c)}e.sort((c,T)=>c.weight!==T.weight?c.weight-T.weight:T.id.localeCompare(c.id));const r=e.length,m=(l.page-1)*l.pageSize,f=m+l.pageSize;return{code:0,msg:"success",data:{items:e.slice(m,f),total:r,page:l.page,pageSize:l.pageSize}}},async createImageConfig(l){await F(P);const e={...l,id:Math.random().toString(36).substr(2,9),statusTest:!1,statusLive:!1,lastModifiedAt:new Date().toISOString(),lastModifiedBy:"admin"};return g.unshift(e),{code:0,msg:"success",data:e}},async updateImageConfig(l,e){await F(P);const r=g.findIndex(m=>m.id===l);return r===-1?{code:404,msg:"Not found"}:(g[r]={...g[r],...e,lastModifiedAt:new Date().toISOString(),lastModifiedBy:"admin"},{code:0,msg:"success"})},async deleteImageConfig(l){await F(P);const e=g.findIndex(r=>r.id===l);return e===-1?{code:404,msg:"Not found"}:(g.splice(e,1),{code:0,msg:"success"})},async toggleStatus(l,e,r){await F(P);const m=g.findIndex(f=>f.id===l);return m===-1?{code:404,msg:"Not found"}:(e==="test"?g[m].statusTest=r:g[m].statusLive=r,g[m].lastModifiedAt=new Date().toISOString(),g[m].lastModifiedBy="admin",console.log(`[Cache] Updating ImageConfig_Cache_Key for ${l} on ${e} to ${r}`),{code:0,msg:"success"})},async uploadImage(l){return await F(1e3),{code:0,msg:"success",data:{url:`https://via.placeholder.com/500x200?text=${encodeURIComponent(l.name)}`}}}},Fe={class:"p-4"},Re={class:"flex gap-2"},Be={key:0,class:"ml-1"},Pe={class:"flex flex-col gap-1"},Ae={class:"text-xs text-gray-500"},je={class:"flex flex-col gap-1"},Ye={class:"text-xs text-gray-500"},He={class:"flex gap-4"},ze={class:"flex flex-col gap-2 items-center"},Ve={key:0,class:"relative group cursor-pointer"},qe=["src"],Ge={class:"text-xs text-gray-400"},Ze={class:"flex justify-end gap-3 mt-6"},Ke=Te({__name:"ImageConfig",setup(l){const{t:e}=Ne(),r=_e(),m=Ee(),f=(t,n="yyyy-MM-dd HH:mm")=>{const s=new Date(t);if(isNaN(s.getTime()))return"";const u=we=>we.toString().padStart(2,"0"),y=s.getFullYear(),N=u(s.getMonth()+1),C=u(s.getDate()),V=u(s.getHours()),q=u(s.getMinutes()),ae=u(s.getSeconds());return n==="yyyy-MM-dd HH:mm:ss"?`${y}-${N}-${C} ${V}:${q}:${ae}`:n==="yyyy-MM-dd HH:mm"?`${y}-${N}-${C} ${V}:${q}`:n==="yyyy-MM-dd'T'HH:mm:ss'Z'"?`${y}-${N}-${C}T${V}:${q}:${ae}Z`:`${y}-${N}-${C} ${V}:${q}`},S=v(!1),c=v([]),T=v(0),D=Z({page:1,pageSize:10,showSizePicker:!0,pageSizes:[10,20,50],onChange:t=>{D.page=t,x()},onUpdatePageSize:t=>{D.pageSize=t,D.page=1,x()}}),b=Z({types:[],startTime:void 0,endTime:void 0}),B=v(null),X=[{label:"首頁 Banner",value:h.BANNER},{label:"促銷彈窗",value:h.POPUP}],de=[{label:"每次登入",value:w.EVERY_LOGIN},{label:"每日一次",value:w.DAILY_ONCE},{label:"永久一次",value:w.ONCE_FOREVER}],M=v(!1),Y=v("add"),H=v(null),d=Z({type:h.BANNER,title:"",imageUrl:"",jumpUrl:"",startTime:f(new Date,"yyyy-MM-dd'T'HH:mm:ss'Z'"),endTime:f(new Date(Date.now()+30*24*60*60*1e3),"yyyy-MM-dd'T'HH:mm:ss'Z'"),weight:1,frequency:w.EVERY_LOGIN}),$=v([new Date().getTime(),new Date(Date.now()+30*24*60*60*1e3).getTime()]),x=async()=>{S.value=!0;try{const t=await R.getImageConfigs({...b,page:D.page,pageSize:D.pageSize});t.code===0&&t.data&&(c.value=t.data.items,T.value=t.data.total)}catch{r.error(e("common.loadFailed"))}finally{S.value=!1}},ue=()=>{B.value?(b.startTime=new Date(B.value[0]).toISOString(),b.endTime=new Date(B.value[1]).toISOString()):(b.startTime=void 0,b.endTime=void 0),D.page=1,x()},me=()=>{Y.value="add",H.value=null,Object.assign(d,{type:h.BANNER,title:"",imageUrl:"",jumpUrl:"",startTime:f(new Date,"yyyy-MM-dd'T'HH:mm:ss'Z'"),endTime:f(new Date(Date.now()+30*24*60*60*1e3),"yyyy-MM-dd'T'HH:mm:ss'Z'"),weight:1,frequency:w.EVERY_LOGIN}),$.value=[new Date().getTime(),new Date(Date.now()+30*24*60*60*1e3).getTime()],M.value=!0},ce=t=>{Y.value="edit",H.value=t.id,Object.assign(d,{type:t.type,title:t.title,imageUrl:t.imageUrl,jumpUrl:t.jumpUrl||"",startTime:t.startTime,endTime:t.endTime,weight:t.weight,frequency:t.frequency||w.EVERY_LOGIN}),$.value=[new Date(t.startTime).getTime(),new Date(t.endTime).getTime()],M.value=!0},ge=t=>{m.warning({title:e("common.warning"),content:e("announcement.deleteConfirm"),positiveText:e("common.confirm"),negativeText:e("common.cancel"),onPositiveClick:async()=>{try{(await R.deleteImageConfig(t)).code===0&&(r.success(e("announcement.deleteSuccess")),x())}catch{r.error(e("common.error"))}}})},pe=async()=>{d.startTime=new Date($.value[0]).toISOString(),d.endTime=new Date($.value[1]).toISOString();try{Y.value==="add"?(await R.createImageConfig(d)).code===0&&(r.success(e("announcement.addSuccess")),M.value=!1,x()):H.value&&(await R.updateImageConfig(H.value,d)).code===0&&(r.success(e("announcement.updateSuccess")),M.value=!1,x())}catch{r.error(e("common.error"))}},k=v({}),ee=De(()=>Object.keys(k.value).length>0),z=v(!1),fe=(t,n)=>{k.value[`${t}_weight`]={field:"weight",value:n}},te=(t,n,s)=>{k.value[`${t}_${n}`]={field:n==="test"?"statusTest":"statusLive",value:s}},ye=async()=>{S.value=!0;try{const t=new Map;Object.entries(k.value).forEach(([y,N])=>{const C=y.split("_")[0];t.has(C)||t.set(C,{}),t.get(C)[N.field]=N.value});const n=Array.from(t.entries()).map(([y,N])=>R.updateImageConfig(y,N)),s=await Promise.all(n),u=s.filter(y=>y.code===0).length;u===s.length?r.success(e("common.success")):r.warning(`部分存取失敗 (${u}/${s.length})`),z.value=!1,k.value={},x()}catch{r.error(e("common.error"))}finally{S.value=!1}},ve=async({file:t,onFinish:n,onError:s})=>{try{const u=await R.uploadImage(t.file);u.code===0&&u.data?(d.imageUrl=u.data.url,n()):s()}catch{s()}},he=[{title:e("imageConfig.type"),key:"type",width:100,render(t){const s={[h.BANNER]:{type:"info",label:"Banner"},[h.POPUP]:{type:"success",label:"彈窗"}}[t.type];return I(Oe,{type:s.type,bordered:!1},{default:()=>s.label})}},{title:"預覽",key:"imageUrl",width:120,render(t){return I($e,{width:80,src:t.imageUrl,objectFit:"contain"})}},{title:e("imageConfig.title"),key:"title",width:200,ellipsis:{tooltip:!0}},{title:e("announcement.weight"),key:"weight",width:100,render(t){return I(le,{size:"small",value:t.weight,min:1,max:999,"onUpdate:value":n=>{n&&(t.weight=n,fe(t.id,n))}})}},{title:e("announcement.publishInterval"),key:"interval",width:280,render(t){return`${f(t.startTime)} - ${f(t.endTime)}`}},{title:e("announcement.statusTest"),key:"statusTest",width:100,render(t){return I(oe,{value:t.statusTest,"onUpdate:value":n=>{t.statusTest=n,te(t.id,"test",n)}})}},{title:e("announcement.statusLive"),key:"statusLive",width:100,render(t){return I(oe,{value:t.statusLive,"onUpdate:value":n=>{t.statusLive=n,te(t.id,"live",n)}})}},{title:e("common.action"),key:"actions",width:120,fixed:"right",render(t){return I(W,null,{default:()=>[I(U,{size:"small",onClick:()=>ce(t)},{default:()=>e("common.edit")}),I(U,{size:"small",type:"error",ghost:!0,onClick:()=>ge(t.id)},{default:()=>e("common.delete")})]})}}];return xe(x),(t,n)=>(G(),K("div",Fe,[i(a(ne),{title:"圖片管理",class:"shadow-sm rounded-lg border-none"},{"header-extra":o(()=>[i(a(U),{type:"info",onClick:me},{default:o(()=>[L(_(a(e)("common.add")),1)]),_:1})]),default:o(()=>[i(a(W),{vertical:"",size:"large"},{default:o(()=>[p("div",Re,[i(a(U),{type:"warning",disabled:!ee.value,onClick:n[0]||(n[0]=s=>z.value=!0),loading:S.value},{default:o(()=>[L(_(a(e)("game.list.accessOperation"))+" ",1),ee.value?(G(),K("span",Be,"("+_(Object.keys(k.value).length)+")",1)):Ce("",!0)]),_:1},8,["disabled","loading"])]),i(a(ne),{embedded:"",bordered:!1,size:"small"},{default:o(()=>[i(a(W),{align:"end",wrap:""},{default:o(()=>[p("div",Pe,[p("span",Ae,_(a(e)("imageConfig.type")),1),i(a(J),{value:b.types,"onUpdate:value":n[1]||(n[1]=s=>b.types=s),multiple:"",options:X,placeholder:a(e)("common.all"),style:{width:"240px"}},null,8,["value","placeholder"])]),p("div",je,[p("span",Ye,_(a(e)("announcement.publishInterval")),1),i(a(re),{value:B.value,"onUpdate:value":n[2]||(n[2]=s=>B.value=s),type:"datetimerange",clearable:"",style:{width:"380px"}},null,8,["value"])]),i(a(U),{type:"primary",onClick:ue},{default:o(()=>[L(_(a(e)("common.search")),1)]),_:1})]),_:1})]),_:1}),i(a(ke),{remote:"",loading:S.value,columns:he,data:c.value,pagination:D,"row-key":s=>s.id,"scroll-x":"1200"},null,8,["loading","data","pagination","row-key"])]),_:1})]),_:1}),i(a(se),{show:z.value,"onUpdate:show":n[3]||(n[3]=s=>z.value=s),preset:"dialog",type:"warning",title:a(e)("common.warning"),content:a(e)("game.list.saveConfirm"),"positive-text":a(e)("common.confirm"),"negative-text":a(e)("common.cancel"),onPositiveClick:ye},null,8,["show","title","content","positive-text","negative-text"]),i(a(se),{show:M.value,"onUpdate:show":n[11]||(n[11]=s=>M.value=s),preset:"card",title:Y.value==="add"?a(e)("common.add"):a(e)("common.edit"),style:{width:"800px"}},{default:o(()=>[i(a(Ie),{model:d,"label-placement":"left","label-width":"120","require-mark-placement":"right-hanging"},{default:o(()=>[i(a(Ue),{cols:2,"x-gap":24},{default:o(()=>[i(a(E),{span:2},{default:o(()=>[i(a(O),{label:a(e)("imageConfig.type"),path:"type"},{default:o(()=>[i(a(J),{value:d.type,"onUpdate:value":n[4]||(n[4]=s=>d.type=s),options:X},null,8,["value"])]),_:1},8,["label"])]),_:1}),i(a(E),{span:2},{default:o(()=>[i(a(O),{label:a(e)("imageConfig.title"),path:"title"},{default:o(()=>[i(a(ie),{value:d.title,"onUpdate:value":n[5]||(n[5]=s=>d.title=s),maxlength:50,"show-count":""},null,8,["value"])]),_:1},8,["label"])]),_:1}),i(a(E),{span:2},{default:o(()=>[i(a(O),{label:a(e)("imageConfig.preview"),path:"images"},{default:o(()=>[p("div",He,[p("div",ze,[i(a(Me),{action:"#","custom-request":ve,"show-file-list":!1},{default:o(()=>[d.imageUrl?(G(),K("div",Ve,[p("img",{src:d.imageUrl,class:"h-32 object-contain border rounded shadow-sm"},null,8,qe),n[12]||(n[12]=p("div",{class:"absolute inset-0 bg-black/50 hidden group-hover:flex items-center justify-center text-white text-xs"},"更換",-1))])):(G(),Se(a(U),{key:1,size:"small",dashed:""},{default:o(()=>[...n[13]||(n[13]=[L("上傳圖片",-1)])]),_:1}))]),_:1})])])]),_:1},8,["label"])]),_:1}),i(a(E),{span:2},{default:o(()=>[i(a(O),{label:a(e)("announcement.jumpUrl"),path:"jumpUrl"},{default:o(()=>[i(a(ie),{value:d.jumpUrl,"onUpdate:value":n[6]||(n[6]=s=>d.jumpUrl=s),placeholder:"輸入內部路徑或外部 URL"},null,8,["value"])]),_:1},8,["label"])]),_:1}),i(a(E),{span:2},{default:o(()=>[i(a(O),{label:"顯示頻率",path:"frequency"},{default:o(()=>[i(a(J),{value:d.frequency,"onUpdate:value":n[7]||(n[7]=s=>d.frequency=s),options:de},null,8,["value"])]),_:1})]),_:1}),i(a(E),null,{default:o(()=>[i(a(O),{label:a(e)("announcement.weight"),path:"weight"},{feedback:o(()=>[p("span",Ge,_(a(e)("announcement.weightTip")),1)]),default:o(()=>[i(a(le),{value:d.weight,"onUpdate:value":n[8]||(n[8]=s=>d.weight=s),min:1,max:999},null,8,["value"])]),_:1},8,["label"])]),_:1}),i(a(E),{span:2},{default:o(()=>[i(a(O),{label:a(e)("announcement.publishInterval")},{default:o(()=>[i(a(re),{value:$.value,"onUpdate:value":n[9]||(n[9]=s=>$.value=s),type:"datetimerange"},null,8,["value"])]),_:1},8,["label"])]),_:1})]),_:1}),p("div",Ze,[i(a(U),{onClick:n[10]||(n[10]=s=>M.value=!1)},{default:o(()=>[L(_(a(e)("common.cancel")),1)]),_:1}),i(a(U),{type:"primary",onClick:pe},{default:o(()=>[L(_(a(e)("common.confirm")),1)]),_:1})])]),_:1},8,["model"])]),_:1},8,["show","title"])]))}}),xt=be(Ke,[["__scopeId","data-v-996a47e6"]]);export{xt as default};
