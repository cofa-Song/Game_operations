import{e as R,P as M,o as P,v as A,E as l,D as p,F as o,w as S,K as y,J as x,Q as B,Y as $,Z as v,$ as _,a1 as j,r as O,a0 as H,j as Z,s as J,h as m}from"./index-BsKuKuBe.js";import{N as K}from"./DataTable-D5mRR0cm.js";import{N as C}from"./Select-CCDzjsmj.js";import{N as Q}from"./InputNumber-BMu_ZOnr.js";import{N as Y}from"./Switch-DXNn_bI_.js";import{N as D}from"./Tag-I3_cH6qL.js";import{N as G}from"./Space-Cf9Hs1lp.js";import"./Radio-C5fS5KPL.js";import"./RadioGroup-CgIVku-C.js";import"./Tooltip-XZFA5Owl.js";import"./Popover-CfBNgOAF.js";import"./use-compitable-BjMNwQgq.js";import"./Dropdown-CcmdnIk3.js";import"./Icon-CbayTH31.js";import"./create-Bj8PAPmY.js";import"./use-keyboard-kkRvbDTj.js";import"./create-ref-setter-C4J8sofl.js";import"./Empty-DtuLCoXR.js";import"./Pagination-BLbp2o8H.js";import"./Forward-CBwL8ab_.js";import"./Add-BJRbFrfV.js";const N=()=>new Date().toISOString(),g=d=>new Date(Date.now()-d*24*60*60*1e3).toISOString(),c=[{id:"V1",platforms:["IOS","ANDROID"],version:"1.2.0",build:120,update_type:"OPTION",download_link:"https://example.com/download/1.2.0.apk",title:"發現新版本！",changelog:{zh:`- 修復若干問題
- 性能優化
- UI 改進`},enabled:!0,created_at:g(7),updated_at:N()},{id:"V2",platforms:["IOS"],version:"1.1.9",build:119,update_type:"NONE",download_link:"https://apps.apple.com/tw/app/example/id123456789",title:"舊版本（不提示）",changelog:{zh:"- 維護版本"},enabled:!1,created_at:g(14),updated_at:g(14)},{id:"V3",platforms:["ANDROID"],version:"1.2.1",build:121,update_type:"FORCE",download_link:"https://play.google.com/store/apps/details?id=com.example.app",title:"重要更新（測試帳號強更）",changelog:{zh:`- 修復登入安全問題
- 強制更新`},enabled:!0,created_at:g(3),updated_at:N()},{id:"V4",platforms:["H5"],version:"2.0.0",build:200,update_type:"FORCE",download_link:"https://example.com/h5-2.0.0.zip",title:"主要版本更新（強更）",changelog:{zh:`- 全新 UI 設計
- 遊戲效能提升 50%
- 支援新功能
- 強制更新`},enabled:!0,created_at:g(1),updated_at:N()},{id:"V5",platforms:["IOS","ANDROID"],version:"1.0.0",build:100,update_type:"OPTION",download_link:"https://example.com/download/1.0.0.apk",title:"初始版本",changelog:{zh:"- 首次發佈"},enabled:!0,created_at:g(30),updated_at:g(30)},{id:"V6",platforms:["ANDROID"],version:"1.3.0",build:130,update_type:"OPTION",download_link:"https://play.google.com/store/apps/details?id=com.example.app",title:"代理版本專用",changelog:{zh:`- 代理後台功能
- 報表增強
- 代理佣金管理`},enabled:!0,created_at:g(5),updated_at:N()}],b=(d=300)=>new Promise(n=>setTimeout(n,d));function w(d,n){const s=d.split(".").map(u=>parseInt(u||"0",10)),r=n.split(".").map(u=>parseInt(u||"0",10));for(let u=0;u<Math.max(s.length,r.length);u++){const f=s[u]||0,e=r[u]||0;if(f>e)return 1;if(f<e)return-1}return 0}const h={async list(){return await b(),{code:0,msg:"success",data:c}},async get(d){await b();const n=c.find(s=>s.id===d);return n?{code:0,msg:"success",data:n}:{code:404,msg:"Not found"}},async create(d){await b();const n=`V${Math.floor(Math.random()*1e5)}`,s=new Date().toISOString(),r={id:n,...d,enabled:d.enabled===void 0?!0:d.enabled,created_at:s,updated_at:s};return c.unshift(r),{code:0,msg:"success",data:r}},async update(d,n){await b();const s=c.findIndex(r=>r.id===d);return s===-1?{code:404,msg:"Not found"}:(c[s]={...c[s],...n,updated_at:new Date().toISOString()},{code:0,msg:"success"})},async remove(d){await b();const n=c.findIndex(s=>s.id===d);return n===-1?{code:404,msg:"Not found"}:(c.splice(n,1),{code:0,msg:"success"})},async checkForUpdate(d,n){await b(50);const s=c.filter(e=>e.enabled&&e.platforms.includes(d));if(!s.length)return{code:0,msg:"success",data:{shouldUpdate:!1,force:!1}};s.sort((e,I)=>w(I.version,e.version));const r=s[0];return w(r.version,n)<=0?{code:0,msg:"up-to-date",data:{shouldUpdate:!1,force:!1}}:{code:0,msg:"update available",data:{shouldUpdate:!0,force:s.some(e=>w(e.version,n)===1&&w(r.version,e.version)!==-1&&e.update_type==="FORCE")||r.update_type==="FORCE",latest:r}}}},L={class:"p-6"},W={class:"flex gap-2"},X={class:"flex justify-end gap-2"},Oe=R({__name:"AppVersionManager",setup(d){const n=M(),s=O([]),r=O(!1),u=O(!1),f=O(null),e=H({platforms:["IOS"],version:"1.0.0",build:100,update_type:"OPTION",download_link:"",title:"",changelog:{zh:""},enabled:!0}),I=[{label:"iOS",value:"IOS"},{label:"Android",value:"ANDROID"},{label:"H5",value:"H5"}],U=[{label:"不提示",value:"NONE"},{label:"建議更新",value:"OPTION"},{label:"強制更新",value:"FORCE"}],z=Z(()=>[{title:"版本",key:"version",width:120,render:t=>m("div",{},[m("div",{class:"font-bold"},`v${t.version}`),m("div",{class:"text-xs text-gray-500"},`build ${t.build}`)])},{title:"平台",key:"platforms",width:150,render:t=>t.platforms.map(a=>m(D,{size:"small",class:"mr-1"},{default:()=>a}))},{title:"更新類型",key:"update_type",width:120,render:t=>m(D,{type:t.update_type==="FORCE"?"error":t.update_type==="OPTION"?"warning":"default"},{default:()=>t.update_type})},{title:"狀態",key:"enabled",width:100,render:t=>m(D,{type:t.enabled?"success":"error"},{default:()=>t.enabled?"啟用":"停用"})},{title:"標題",key:"title",width:200,render:t=>t.title},{title:"操作",key:"actions",width:150,align:"center",render:t=>m(G,{},{default:()=>[m(y,{size:"small",onClick:()=>F(t)},{default:()=>"編輯"}),m(y,{size:"small",type:"error",onClick:()=>E(t.id)},{default:()=>"刪除"})]})}]),k=async()=>{r.value=!0;const t=await h.list();t.code===0&&(s.value=t.data||[]),r.value=!1},V=()=>{f.value=null,Object.assign(e,{platforms:["IOS"],version:"1.0.0",build:100,update_type:"OPTION",download_link:"",title:"",changelog:{zh:""},enabled:!0}),u.value=!0},F=t=>{f.value=t,Object.assign(e,{platforms:[...t.platforms],version:t.version,build:t.build,update_type:t.update_type,download_link:t.download_link,title:t.title,changelog:t.changelog,enabled:t.enabled}),u.value=!0},T=async()=>{if(!e.version||!e.build||!e.download_link){n.warning("請填寫必要欄位");return}f.value?(await h.update(f.value.id,e),n.success("已更新")):(await h.create(e),n.success("已新增")),u.value=!1,k()},E=async t=>{confirm("確定刪除？")&&(await h.remove(t),n.success("已刪除"),k())};return P(k),(t,a)=>(J(),A("div",L,[l(o(B),{title:"版本管理",class:"mb-4"},{"header-extra":p(()=>[S("div",W,[l(o(y),{type:"primary",onClick:V},{default:p(()=>[...a[10]||(a[10]=[x("新增版本",-1)])]),_:1})])]),default:p(()=>[l(o(K),{columns:z.value,data:s.value,loading:r.value,bordered:!1,"single-line":!1},null,8,["columns","data","loading"])]),_:1}),l(o(j),{show:u.value,"onUpdate:show":a[9]||(a[9]=i=>u.value=i),title:"版本設定",preset:"card",style:{width:"720px"}},{footer:p(()=>[S("div",X,[l(o(y),{onClick:a[8]||(a[8]=i=>u.value=!1)},{default:p(()=>[...a[11]||(a[11]=[x("取消",-1)])]),_:1}),l(o(y),{type:"primary",onClick:T},{default:p(()=>[...a[12]||(a[12]=[x("儲存",-1)])]),_:1})])]),default:p(()=>[l(o($),{model:e},{default:p(()=>[l(o(v),{label:"裝置平台"},{default:p(()=>[l(o(C),{value:e.platforms,"onUpdate:value":a[0]||(a[0]=i=>e.platforms=i),multiple:"",options:I},null,8,["value"])]),_:1}),l(o(v),{label:"版本號 (Version)"},{default:p(()=>[l(o(_),{value:e.version,"onUpdate:value":a[1]||(a[1]=i=>e.version=i)},null,8,["value"])]),_:1}),l(o(v),{label:"版本代碼 (Build)"},{default:p(()=>[l(o(Q),{value:e.build,"onUpdate:value":a[2]||(a[2]=i=>e.build=i),min:1,style:{width:"120px"}},null,8,["value"])]),_:1}),l(o(v),{label:"更新類型"},{default:p(()=>[l(o(C),{value:e.update_type,"onUpdate:value":a[3]||(a[3]=i=>e.update_type=i),options:U},null,8,["value"])]),_:1}),l(o(v),{label:"下載連結"},{default:p(()=>[l(o(_),{value:e.download_link,"onUpdate:value":a[4]||(a[4]=i=>e.download_link=i)},null,8,["value"])]),_:1}),l(o(v),{label:"更新標題"},{default:p(()=>[l(o(_),{value:e.title,"onUpdate:value":a[5]||(a[5]=i=>e.title=i)},null,8,["value"])]),_:1}),l(o(v),{label:"更新日誌 (ZH)"},{default:p(()=>[l(o(_),{value:e.changelog.zh,"onUpdate:value":a[6]||(a[6]=i=>e.changelog.zh=i),type:"textarea",rows:"6"},null,8,["value"])]),_:1}),l(o(v),{label:"發佈狀態"},{default:p(()=>[l(o(Y),{value:e.enabled,"onUpdate:value":a[7]||(a[7]=i=>e.enabled=i)},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["show"])]))}});export{Oe as default};
