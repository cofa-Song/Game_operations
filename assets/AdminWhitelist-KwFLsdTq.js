import{e as H,A as R,P as X,o as q,v as M,E as l,D as s,F as r,Y as U,Z as y,$ as P,K as g,J as h,Q as j,w as B,G as ee,W as te,a1 as V,r as k,a0 as A,j as E,s as F,h as N}from"./index-BsKuKuBe.js";import{S as ae}from"./SearchOutline-tjJoWZeT.js";import{C as le}from"./CreateOutline-CbXbgX50.js";import{N as re}from"./Select-CCDzjsmj.js";import{N as T}from"./Icon-CbayTH31.js";import{N as ne}from"./DataTable-D5mRR0cm.js";import{N as $}from"./Switch-DXNn_bI_.js";import{N as se}from"./Space-Cf9Hs1lp.js";import"./Popover-CfBNgOAF.js";import"./use-compitable-BjMNwQgq.js";import"./Tag-I3_cH6qL.js";import"./create-Bj8PAPmY.js";import"./Empty-DtuLCoXR.js";import"./Radio-C5fS5KPL.js";import"./RadioGroup-CgIVku-C.js";import"./Tooltip-XZFA5Owl.js";import"./Dropdown-CcmdnIk3.js";import"./use-keyboard-kkRvbDTj.js";import"./create-ref-setter-C4J8sofl.js";import"./Pagination-BLbp2o8H.js";import"./Forward-CBwL8ab_.js";const oe=()=>new Date().toISOString(),w=n=>new Date(Date.now()-n*60*60*1e3).toISOString(),p=[{id:"W1",cidr:"127.0.0.1",remark:"Localhost (dev)",enabled:!0,creator:"system",created_at:oe()},{id:"W2",cidr:"192.168.1.0/24",remark:"台北總部辦公室",enabled:!0,creator:"admin",created_at:w(30)},{id:"W3",cidr:"10.0.0.0/8",remark:"公司內部網路",enabled:!0,creator:"admin",created_at:w(60)},{id:"W4",cidr:"203.70.50.100",remark:"維運工程師 A (李先生)",enabled:!0,creator:"admin",created_at:w(14)},{id:"W5",cidr:"211.20.1.50",remark:"維運工程師 B (王小姐)",enabled:!0,creator:"admin",created_at:w(14)},{id:"W6",cidr:"172.16.0.0/12",remark:"新竹分公司 VPN",enabled:!0,creator:"manager",created_at:w(21)},{id:"W7",cidr:"1.2.3.4",remark:"臨時訪客 IP（已過期，停用中）",enabled:!1,creator:"admin",created_at:w(45)},{id:"W8",cidr:"8.8.8.8",remark:"測試 IP（暫未啟用）",enabled:!1,creator:"admin",created_at:w(3)}],I=(n=200)=>new Promise(a=>setTimeout(a,n));function z(n){if(typeof n!="string")return null;const a=n.split(".").map(o=>parseInt(o,10));return a.length!==4||a.some(isNaN)?null:(a[0]<<24>>>0)+(a[1]<<16)+(a[2]<<8)+a[3]}function O(n,a){if(!n)return!1;if(n.indexOf("/")===-1)return n===a;const[o,u]=n.split("/"),c=parseInt(u||"32",10),i=z(a),m=z(o);if(i===null||m===null)return!1;const v=c===0?0:-1<<32-c>>>0;return(i&v)===(m&v)}const S={async list(){return await I(),{code:0,msg:"success",data:p}},async create(n){await I();const a=`W${Math.floor(Math.random()*1e5)}`,o=new Date().toISOString(),u={id:a,cidr:n.cidr,remark:n.remark,enabled:n.enabled===void 0?!0:n.enabled,created_at:o,updated_at:o};return p.unshift(u),{code:0,msg:"success",data:u}},async update(n,a,o){await I();const u=p.findIndex(c=>c.id===n);return u===-1?{code:404,msg:"Not found"}:o&&a.enabled===!1&&!p.map((m,v)=>({...m,...v===u?{...m,...a}:m})).some(m=>m.enabled&&O(m.cidr,o))?{code:403,msg:"Operation would lock out current IP"}:(p[u]={...p[u],...a,updated_at:new Date().toISOString()},{code:0,msg:"success"})},async remove(n,a){await I();const o=p.findIndex(u=>u.id===n);return o===-1?{code:404,msg:"Not found"}:a&&O(p[o].cidr,a)&&p[o].enabled&&!p.filter((i,m)=>m!==o&&i.enabled).some(i=>O(i.cidr,a))?{code:403,msg:"Cannot remove last rule matching your current IP"}:(p.splice(o,1),{code:0,msg:"success"})},async isAllowed(n){return await I(),{code:0,msg:"success",data:{allowed:p.some(o=>o.enabled&&O(o.cidr,n))}}}},de={class:"p-6"},ie={class:"flex gap-2"},ue={key:0,class:"ml-1"},ce={class:"flex justify-end gap-2"},Ue=H({__name:"AdminWhitelist",setup(n){R();const a=X(),o=k([]),u=k([]),c=k(!1),i=A({cidr:"",enabled:null}),m=[{label:"全部",value:null},{label:"啟用",value:1},{label:"停用",value:0}],v=k(!1),C=k(null),b=k({}),W=E(()=>Object.keys(b.value).length>0),x=k(!1),f=A({cidr:"",remark:"",enabled:!0}),G=E(()=>[{title:"IP / 網段",key:"cidr",width:180,render:e=>N("div",{class:"font-mono"},e.cidr)},{title:"備註",key:"remark",width:200,render:e=>e.remark},{title:"建立者",key:"creator",width:120,render:e=>e.creator||"-"},{title:"狀態",key:"enabled",width:100,render:e=>{const t=b.value[e.id]!==void 0?b.value[e.id]:e.enabled;return N($,{value:t,onUpdateValue:d=>J(e,d)})}},{title:"操作",key:"actions",width:160,align:"center",render:e=>N(se,{},{default:()=>[N(g,{size:"small",onClick:()=>Q(e)},{default:()=>"編輯"}),N(g,{size:"small",type:"error",onClick:()=>Z(e.id)},{default:()=>"刪除"})]})}]),_=async()=>{c.value=!0,b.value={};const e=await S.list();e.code===0&&(o.value=e.data||[],D()),c.value=!1},D=()=>{u.value=o.value.filter(e=>{const t=!i.cidr||e.cidr.includes(i.cidr),d=i.enabled===null||(e.enabled?1:0)===i.enabled;return t&&d})},J=(e,t)=>{e.enabled===t?delete b.value[e.id]:b.value[e.id]=t},K=async()=>{c.value=!0;try{const e=Object.entries(b.value).map(([t,d])=>S.update(t,{enabled:d}));await Promise.all(e),a.success("存取成功"),x.value=!1,_()}catch{a.error("存取失敗")}finally{c.value=!1}},L=()=>{C.value=null,Object.assign(f,{cidr:"",remark:"",enabled:!0}),v.value=!0},Q=e=>{C.value=e,Object.assign(f,{cidr:e.cidr,remark:e.remark,enabled:e.enabled}),v.value=!0},Y=async()=>{if(!f.cidr||!f.remark){a.warning("請填寫 IP / 網段 與 備註");return}if(C.value){const e=await S.update(C.value.id,f);e.code===0?a.success("已更新"):a.error(e.msg)}else{const e=await S.create(f);e.code===0?a.success("已新增"):a.error(e.msg)}v.value=!1,_()},Z=async e=>{if(!confirm("確定刪除？"))return;const t=await S.remove(e);t.code===0?(a.success("已刪除"),_()):a.error(t.msg)};return q(()=>{_()}),(e,t)=>(F(),M("div",de,[l(r(j),{title:"查詢條件",class:"mb-4"},{default:s(()=>[l(r(U),{inline:"",model:i,"label-placement":"left","label-width":"auto"},{default:s(()=>[l(r(y),{label:"IP / 網段"},{default:s(()=>[l(r(P),{value:i.cidr,"onUpdate:value":t[0]||(t[0]=d=>i.cidr=d),placeholder:"搜尋 IP 或網段",clearable:""},null,8,["value"])]),_:1}),l(r(y),{label:"狀態"},{default:s(()=>[l(r(re),{value:i.enabled,"onUpdate:value":t[1]||(t[1]=d=>i.enabled=d),options:m,style:{width:"120px"}},null,8,["value"])]),_:1}),l(r(y),null,{default:s(()=>[l(r(g),{type:"primary",onClick:D},{icon:s(()=>[l(r(T),null,{default:s(()=>[l(r(ae))]),_:1})]),default:s(()=>[t[9]||(t[9]=h(" 查詢 ",-1))]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),l(r(j),{title:"後台白名單管理",class:"mb-4"},{"header-extra":s(()=>[B("div",ie,[l(r(g),{type:"warning",disabled:!W.value,onClick:t[2]||(t[2]=d=>x.value=!0),loading:c.value},{icon:s(()=>[l(r(T),null,{default:s(()=>[l(r(le))]),_:1})]),default:s(()=>[t[10]||(t[10]=h(" 存取操作 ",-1)),W.value?(F(),M("span",ue,"("+ee(Object.keys(b.value).length)+")",1)):te("",!0)]),_:1},8,["disabled","loading"]),l(r(g),{type:"primary",onClick:L},{default:s(()=>[...t[11]||(t[11]=[h("新增白名單",-1)])]),_:1})])]),default:s(()=>[l(r(ne),{columns:G.value,data:u.value,loading:c.value,bordered:!1,"single-line":!1},null,8,["columns","data","loading"])]),_:1}),l(r(V),{show:v.value,"onUpdate:show":t[7]||(t[7]=d=>v.value=d),title:"白名單設定",preset:"card",style:{width:"640px"}},{footer:s(()=>[B("div",ce,[l(r(g),{onClick:t[6]||(t[6]=d=>v.value=!1)},{default:s(()=>[...t[12]||(t[12]=[h("取消",-1)])]),_:1}),l(r(g),{type:"primary",onClick:Y},{default:s(()=>[...t[13]||(t[13]=[h("儲存",-1)])]),_:1})])]),default:s(()=>[l(r(U),{model:f},{default:s(()=>[l(r(y),{label:"IP / 網段"},{default:s(()=>[l(r(P),{value:f.cidr,"onUpdate:value":t[3]||(t[3]=d=>f.cidr=d),placeholder:"例如 1.2.3.4 或 1.2.3.0/24"},null,8,["value"])]),_:1}),l(r(y),{label:"備註"},{default:s(()=>[l(r(P),{value:f.remark,"onUpdate:value":t[4]||(t[4]=d=>f.remark=d)},null,8,["value"])]),_:1}),l(r(y),{label:"啟用狀態"},{default:s(()=>[l(r($),{value:f.enabled,"onUpdate:value":t[5]||(t[5]=d=>f.enabled=d)},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["show"]),l(r(V),{show:x.value,"onUpdate:show":t[8]||(t[8]=d=>x.value=d),preset:"dialog",type:"warning",title:"警告",content:"確定要存取狀態變更？","positive-text":"確認","negative-text":"取消",onPositiveClick:K},null,8,["show"])]))}});export{Ue as default};
