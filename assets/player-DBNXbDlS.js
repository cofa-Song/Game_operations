import{C as l,B as S}from"./bonus-WzX8Tgz6.js";import{a as v}from"./assetLogs-Dslkok5U.js";class h{static getWallet(e,t){return e.wallets.find(n=>n.type===t)}static createLog(e,t,n,s,o,r){const i=e.wallets.find(_=>_.type===n),c=e.rollover_container,f={log_id:`LOG_${Date.now()}_${Math.random().toString(36).substr(2,5)}`,timestamp:new Date().toISOString(),player_id:e.id,username:e.username,currency:i?i.currency:"GOLD",wallet_type:n,change_type:t,amount:s,post_balance:i?i.balance:0,valid_turnover:o,remain_target:c&&c.status===l.ACTIVE&&n==="BONUS"?Math.max(0,c.target_wagering-c.current_wagering):0,related_id:r};v(f)}static createBonusCard(e,t,n,s){const o=new Date,r=new Date(o.getTime()+s*24*60*60*1e3);return{id:`CARD_${Math.random().toString(36).substr(2,9).toUpperCase()}`,currency:S.SILVER,start_amount:e,lave_amount:e,multiplier:t,target_current:e*t,cap:n,end_time:r.toISOString(),created_at:o.toISOString()}}static activateBonus(e,t){e.rollover_container||(e.rollover_container={status:l.IDLE,start_balance:0,lave_balance:0,current_wagering:0,target_wagering:0,cap:0});const n=e.rollover_container;if(n.status===l.ACTIVE||new Date(t.end_time)<new Date)return!1;n.status=l.ACTIVE,n.active_card_id=t.id,n.start_balance=t.lave_amount,n.lave_balance=t.lave_amount,n.current_wagering=0,n.target_wagering=t.target_current,n.cap=t.cap;const s=this.getWallet(e,"BONUS");return s&&(s.balance=t.lave_amount,this.createLog(e,"CLAIM","BONUS",t.lave_amount,0,t.id)),!0}static processBet(e,t,n){const s=e.rollover_container;let o=0;if(!s||s.status!==l.ACTIVE){const r=this.getWallet(e,t);r&&(r.balance-=n,this.createLog(e,"BET",t,-n,0));return}if(t==="BONUS"){const r=this.getWallet(e,"BONUS");if(r.balance<n)throw new Error("Insufficient Bonus Balance");r.balance-=n,s.lave_balance=r.balance,s.current_wagering+=n,o=n,this.createLog(e,"BET","BONUS",-n,o),this.checkSettlement(e)}else{const r=this.getWallet(e,t);r&&(r.balance-=n,this.createLog(e,"BET",t,-n,0))}}static processWin(e,t,n){var o;const s=this.getWallet(e,t);s&&(s.balance+=n,t==="BONUS"&&((o=e.rollover_container)==null?void 0:o.status)===l.ACTIVE&&(e.rollover_container.lave_balance=s.balance),this.createLog(e,"WIN",t,n,0),t==="BONUS"&&this.checkSettlement(e))}static checkSettlement(e){const t=e.rollover_container;if(!(!t||t.status!==l.ACTIVE)){if(t.current_wagering>=t.target_wagering){const n=this.getWallet(e,"BONUS"),s=this.getWallet(e,"CASH"),o=Math.min(n.balance,t.cap),r=Math.max(0,n.balance-t.cap);n.balance=0,this.createLog(e,"UNLOCK","BONUS",-o,0,t.active_card_id),s.balance+=o,this.createLog(e,"UNLOCK","CASH",o,0,t.active_card_id),r>0&&this.createLog(e,"WIPE","BONUS",-r,0,"System Cap Wipe"),console.log(`[Engine] Success: Transferred ${o}, Burned ${r}`),this.resetContainer(e),this.tryActivateNext(e);return}if(t.lave_balance<1){console.log("[Engine] Bankruptcy: Balance < 1, Resetting");const n=this.getWallet(e,"BONUS");n.balance>0&&this.createLog(e,"WIPE","BONUS",-n.balance,0,"Bankruptcy"),n.balance=0,this.resetContainer(e),this.tryActivateNext(e)}}}static abandonBonus(e){var t;if(((t=e.rollover_container)==null?void 0:t.status)===l.ACTIVE){const n=this.getWallet(e,"BONUS"),s=n.balance;n.balance=0,this.createLog(e,"WIPE","BONUS",-s,0,"User Abandon"),this.resetContainer(e),this.tryActivateNext(e)}}static resetContainer(e){e.rollover_container&&(e.rollover_container.status=l.IDLE,e.rollover_container.active_card_id=void 0,e.rollover_container.current_wagering=0,e.rollover_container.lave_balance=0,e.rollover_container.start_balance=0,e.rollover_container.target_wagering=0)}static tryActivateNext(e){if(e.bonus_queue&&e.bonus_queue.length>0){const t=e.bonus_queue.shift();console.log(`[Engine] Auto-activating next card: ${t.id}`),this.activateBonus(e,t)}}static exchangeCurrency(e,t,n,s){var c,f;const r=this.getWallet(e,"CASH"),i=this.getWallet(e,"BONUS");if(t==="GOLD"&&n==="SILVER"){if(r.balance<s)throw new Error("Insufficient Gold");r.balance-=s,this.createLog(e,"EXCHANGE","CASH",-s,0,"Exchange Out");const _=s*100;i.balance+=_,this.createLog(e,"EXCHANGE","BONUS",_,0,"Exchange In"),((c=e.rollover_container)==null?void 0:c.status)===l.ACTIVE&&(e.rollover_container.lave_balance=i.balance)}else if(t==="SILVER"&&n==="GOLD"){if(i.balance<s)throw new Error("Insufficient Silver");if(s%100!==0)throw new Error("Silver amount must be multiple of 100");i.balance-=s,this.createLog(e,"EXCHANGE","BONUS",-s,0,"Exchange Out"),((f=e.rollover_container)==null?void 0:f.status)===l.ACTIVE&&(e.rollover_container.lave_balance=i.balance);const _=s/100;r.balance+=_,this.createLog(e,"EXCHANGE","CASH",_,0,"Exchange In")}}static p2pTransfer(e,t,n){const o=this.getWallet(e,"CASH"),r=this.getWallet(t,"CASH"),i=n*(1+.08);if(o.balance<i)throw new Error("Insufficient Balance for Transfer + Fee");o.balance-=i,this.createLog(e,"P2P_OUT","CASH",-i,0,t.id),r.balance+=n,this.createLog(t,"P2P_IN","CASH",n,0,e.id)}}const E=()=>[{type:"CASH",currency:"GOLD",balance:Math.floor(Math.random()*5e4)},{type:"CASH",currency:"SILVER",balance:Math.floor(Math.random()*1e4)},{type:"BONUS",currency:"SILVER",balance:Math.floor(Math.random()*5e3)},{type:"GAME",currency:"BRONZE",balance:Math.floor(Math.random()*1e3)},{type:"SAFE",currency:"GOLD",balance:Math.floor(Math.random()*1e4)}],b=["Alex","Ben","Charlie","David","Eve","Frank","Grace","Helen"],A=["ACTIVE","ACTIVE","ACTIVE","LOCKED","FROZEN","SUSPENDED"],g=Array.from({length:50}).map((a,e)=>{const t={id:`P${1e4+e}`,username:`user_${1e4+e}`,display_name:`${b[e%b.length]}_${e}`,phone:`0912${String(e).padStart(6,"0")}`,status:A[e%6],tags:e%10===0?["TEST","VIP"]:["NORMAL"],vip_level:Math.floor(Math.random()*5),referrer_id:e%5===1?`A${2e4+e}`:void 0,agent_name:e%5===1?`agent_${2e4+e}`:void 0,invite_code:e%5===1?`INV${2e4+e}`:void 0,rtp:parseFloat((Math.random()*40+70).toFixed(2)),register_source:e%3===0?"Admin_Manual":"SEO_Google",register_ip:`192.168.1.${e%255}`,register_at:new Date(Date.now()-Math.random()*1e8).toISOString(),last_login_at:new Date(Date.now()-Math.random()*1e8).toISOString(),last_login_ip:`192.168.1.${e%255}`,is_online:Math.random()>.7,wallets:E(),is_muted:!1,is_gift_disabled:!1,gender:e%3===0?"MALE":e%3===1?"FEMALE":"UNKNOWN",birthday:"1990-01-01",email:`player${e}@example.com`,is_retention_active:e%2===0,bonus_queue:e%4===0?[h.createBonusCard(100,10,500,7),h.createBonusCard(50,5,200,3)]:[],rollover_container:void 0};if(e%5===0&&t.bonus_queue&&t.bonus_queue.length>0){const n=t.bonus_queue.shift();h.activateBonus(t,n)}return t}),w=Array.from({length:20}).map((a,e)=>({id:`LOG_${e}`,player_id:`P${1e4+e%5}`,operator:"admin",action:["UPDATE_STATUS","UPDATE_INFO","ABANDON_BONUS"][e%3],old_value:"ACTIVE",new_value:"LOCKED",reason:"Suspicious activity detected",created_at:new Date(Date.now()-Math.random()*1e8).toISOString()})),u=500,d=a=>new Promise(e=>setTimeout(e,a)),O={async getPlayers(a){await d(u);let e=[...g];if(a.q){const r=a.q.toLowerCase();if(a.search_type)switch(a.search_type){case"id":e=e.filter(i=>i.id.toLowerCase().includes(r));break;case"username":e=e.filter(i=>i.username.toLowerCase().includes(r));break;case"phone":e=e.filter(i=>i.phone.includes(r));break}else e=e.filter(i=>i.id.toLowerCase().includes(r)||i.username.toLowerCase().includes(r)||i.phone.includes(r))}if(a.status&&(e=e.filter(r=>r.status===a.status)),a.affiliation_query){const r=a.affiliation_query.toLowerCase();a.affiliation_type==="invite_code"?e=e.filter(i=>{var c;return(c=i.invite_code)==null?void 0:c.toLowerCase().includes(r)}):a.affiliation_type==="referrer_id"&&(e=e.filter(i=>{var c;return(c=i.referrer_id)==null?void 0:c.toLowerCase().includes(r)}))}if(a.tags&&a.tags.length>0&&(e=e.filter(r=>a.tags.some(i=>r.tags.includes(i)))),a.register_ip&&(e=e.filter(r=>r.register_ip.includes(a.register_ip))),a.register_date_start){const r=new Date(a.register_date_start).getTime();e=e.filter(i=>new Date(i.register_at).getTime()>=r)}if(a.register_date_end){const r=new Date(a.register_date_end).getTime();e=e.filter(i=>new Date(i.register_at).getTime()<=r)}const t=e.length,n=(a.page-1)*a.page_size,s=n+a.page_size;return{code:0,msg:"success",data:{items:e.slice(n,s),total:t,page:a.page,pageSize:a.page_size}}},async getPlayerDetail(a){await d(u);const e=g.find(t=>t.id===a);return e?{code:0,msg:"success",data:e}:{code:404,msg:"Player not found"}},async createPlayer(a){await d(u);const e={id:`P${Math.floor(Math.random()*1e5)}`,username:a.username,display_name:a.display_name,phone:a.phone||"",status:"ACTIVE",tags:a.tags||[],vip_level:a.vip_level||0,referrer_id:a.referrer_id,gender:a.gender,birthday:a.birthday,email:a.email,is_retention_active:a.is_retention_active,is_muted:a.is_muted||!1,is_gift_disabled:a.is_gift_disabled||!1,register_source:"Admin_Manual",register_ip:"127.0.0.1",register_at:new Date().toISOString(),wallets:[{type:"CASH",currency:"GOLD",balance:0},{type:"CASH",currency:"SILVER",balance:0},{type:"BONUS",currency:"SILVER",balance:0},{type:"GAME",currency:"BRONZE",balance:0},{type:"SAFE",currency:"GOLD",balance:0}],is_online:!1};return g.unshift(e),{code:0,msg:"success",data:e}},async updatePlayer(a,e,t){await d(u);const n=g.findIndex(s=>s.id===a);return n===-1?{code:404,msg:"Player not found"}:(console.log(`[Audit] Update Player ${a}:`,e,`Reason: ${t}`),g[n]={...g[n],...e},{code:0,msg:"success"})},async updatePlayerStatus(a,e,t,n){await d(u);const s=g.find(o=>o.id===a);return s?(s.status=e,n&&(e==="FROZEN"||e==="SUSPENDED")&&(s.is_online=!1,console.log(`[WebSocket] Kicking player ${a}`)),console.log(`[Audit] Update Status ${a} -> ${e}: ${t}`),{code:0,msg:"success"}):{code:404,msg:"Player not found"}},async abandonBonus(a,e){await d(u);const t=g.find(s=>s.id===a);if(!t)return{code:404,msg:"Player not found"};const n=t.wallets.find(s=>s.type==="BONUS");return n&&(console.log(`[Audit] Abandon Bonus ${a}: ${n.balance} -> 0. Reason: ${e}`),n.balance=0),{code:0,msg:"success"}},async getAuditLogs(a){return await d(u),{code:0,msg:"success",data:w.filter(t=>t.player_id===a)}}};export{h as R,O as p};
