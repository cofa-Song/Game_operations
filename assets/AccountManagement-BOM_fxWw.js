import{e as ee,s as p,v as E,w as u,P as ye,y as ge,E as l,D as o,J as g,F as t,G as v,X as Ee,$ as D,a6 as be,a7 as _e,K as S,I as C,H as M,Q as Z,Y as xe,Z as h,C as k,a8 as we,W as L,a1 as he,T as Ae,U as J,a5 as F,r as A,a0 as Q,j as B,a2 as X,a4 as W,a3 as G,S as Ne,_ as Re}from"./index-BsKuKuBe.js";import{S as De,A as Se,E as ke,N as Le,D as Pe}from"./SearchOutlined-6trNpiHj.js";import{N as Ue}from"./Pagination-BLbp2o8H.js";import{N as P}from"./Tag-I3_cH6qL.js";import{N as O}from"./Icon-CbayTH31.js";import{N as V}from"./Space-Cf9Hs1lp.js";import{N as $}from"./Spin-D6NC1_9t.js";import{N as Y}from"./Select-CCDzjsmj.js";import{N as Ce,a as Oe}from"./DrawerContent-Dys-I5Rb.js";import"./Popover-CfBNgOAF.js";import"./use-compitable-BjMNwQgq.js";import"./Forward-CBwL8ab_.js";import"./create-Bj8PAPmY.js";import"./create-ref-setter-C4J8sofl.js";import"./Empty-DtuLCoXR.js";const Ve={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 24 24"},ze=ee({name:"SecurityOutlined",render:function(K,z){return p(),E("svg",Ve,z[0]||(z[0]=[u("path",{d:"M12 1L3 5v6c0 5.55 3.84 10.74 9 12c5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z",fill:"currentColor"},null,-1)]))}}),Ie={class:"p-6 space-y-4"},Me={class:"flex justify-between items-center"},Be={class:"flex items-center gap-2"},Ge={class:"min-w-full border-collapse border border-gray-300"},Te={class:"border border-gray-300 px-4 py-2"},qe={class:"font-semibold"},je={key:0,class:"text-red-500"},Fe={class:"border border-gray-300 px-4 py-2"},We={class:"border border-gray-300 px-4 py-2"},$e={class:"border border-gray-300 px-4 py-2"},Ke={key:1,class:"text-gray-400"},He={class:"border border-gray-300 px-4 py-2"},Ze={class:"border border-gray-300 px-4 py-2"},Je={class:"border border-gray-300 px-4 py-2"},Qe={class:"flex justify-end mt-4"},Xe={class:"space-y-2"},Ye={class:"space-y-2 max-h-96 overflow-y-auto"},et={class:"flex items-center justify-between"},tt={class:"font-semibold text-sm"},st={class:"text-xs text-gray-600"},at={class:"text-right"},lt={key:0,class:"text-xs text-gray-600 mt-1"},rt={key:1,class:"text-xs text-gray-600 mt-1"},ot=ee({__name:"AccountManagement",setup(te){const K=ke,z=Pe,se=De,ae=Se,le=ze,m=ye(),c=ge(),_=A([...W]),x=A(!1),I=A(""),T=A(!1),N=Q({page:1,pageSize:10}),R=A(!1),q=A(!1),b=A(null),f=A(null),a=Q({username:"",display_name:"",role:"USER",groups:[],password:"",confirmPassword:"",status:"ENABLED",reason:""}),re=B(()=>{var s,i;const r=[{label:"技術開發",value:"DEVELOPER"},{label:"營運主管",value:"MANAGER"},{label:"一般職員",value:"USER"}];return((s=c.user)==null?void 0:s.role)==="DEVELOPER"?r:((i=c.user)==null?void 0:i.role)==="MANAGER"?r.filter(e=>e.value!=="DEVELOPER"):r.filter(e=>e.value==="USER")}),oe=B(()=>G.filter(r=>r.status==="ENABLED")),H=B(()=>{var s,i,e;let r=_.value;if(T.value||(r=r.filter(n=>!n.deleted_at)),((s=c.user)==null?void 0:s.role)==="MANAGER")r=r.filter(n=>n.role!=="DEVELOPER");else if(((i=c.user)==null?void 0:i.role)==="USER"){const n=((e=W.find(d=>d.id===c.user.user_id))==null?void 0:e.groups)||[];r=r.filter(d=>{var y;return d.role!=="DEVELOPER"&&d.role!=="MANAGER"&&((y=d.groups)==null?void 0:y.some(w=>n.includes(w)))})}if(I.value){const n=I.value.toLowerCase();r=r.filter(d=>d.username.toLowerCase().includes(n)||d.display_name.toLowerCase().includes(n))}return r}),ue=B(()=>{const r=(N.page-1)*N.pageSize;return H.value.slice(r,r+N.pageSize)}),U=r=>{if(r.role==="DEVELOPER")return F.reduce((i,e)=>(i[e.code]="WRITE",i),{});const s={};return F.forEach(i=>{s[i.code]="NONE"}),r.groups&&r.groups.forEach(i=>{const e=G.find(n=>n.id===i);e&&Object.entries(e.permissions).forEach(([n,d])=>{d==="WRITE"?s[n]="WRITE":d==="READ"&&s[n]==="NONE"&&(s[n]="READ")})}),s},j=r=>{switch(r){case"DEVELOPER":return"error";case"MANAGER":return"warning";case"USER":return"default";default:return"default"}},ne=r=>{switch(r){case"ENABLED":return"success";case"DISABLED":return"error";case"LOCKED":return"warning";default:return"default"}},de=r=>{switch(r){case"ENABLED":return"啟用";case"DISABLED":return"停用";case"LOCKED":return"鎖定";default:return"-"}},ie=()=>{b.value=null,a.username="",a.display_name="",a.role="USER",a.groups=[],a.password="",a.confirmPassword="",a.status="ENABLED",a.reason="",R.value=!0},pe=r=>{b.value=r.id,a.username=r.username,a.display_name=r.display_name,a.role=r.role,a.groups=r.groups||[],a.password="",a.confirmPassword="",a.status=r.status,a.reason="",R.value=!0},ce=async()=>{try{if(!a.username.trim()){m.error("帳號不可為空");return}if(!a.display_name.trim()){m.error("顯示名稱不可為空");return}if(b.value&&!a.reason.trim()){m.error("請輸入異動原因");return}if(!b.value){if(_.value.some(s=>s.username===a.username&&!s.deleted_at)){m.error("帳號已存在");return}if(!a.password){m.error("請輸入密碼");return}if(a.password!==a.confirmPassword){m.error("密碼不一致");return}if(!me(a.password)){m.error("密碼需為 6-16 位元英數字");return}}if(a.role==="USER"&&a.groups.length===0){m.error("一般使用者必須分配至少一個群組");return}if(x.value=!0,await X(),b.value){const r=_.value.findIndex(s=>s.id===b.value);r!==-1&&(_.value[r]={..._.value[r],display_name:a.display_name,role:a.role,groups:a.role==="USER"?a.groups:void 0,status:a.status,updated_at:new Date().toLocaleString()},m.success("帳號更新成功"))}else{const r={id:`admin-${Date.now()}`,username:a.username,display_name:a.display_name,role:a.role,groups:a.role==="USER"?a.groups:void 0,status:a.status,two_fa_enabled:!1,created_at:new Date().toLocaleString(),updated_at:new Date().toLocaleString()};_.value.push(r),m.success("帳號建立成功")}R.value=!1}catch{m.error("保存失敗")}finally{x.value=!1}},fe=async r=>{var s;try{x.value=!0,await X();const i=_.value.findIndex(e=>e.id===r.id);i!==-1&&(_.value[i].deleted_at=new Date().toLocaleString(),_.value[i].deleted_by=((s=c.user)==null?void 0:s.user_id)||"admin"),m.success("帳號已刪除")}catch{m.error("刪除失敗")}finally{x.value=!1}},ve=r=>{f.value=r,q.value=!0},me=r=>/^[a-zA-Z0-9]{6,16}$/.test(r);return(r,s)=>{var i;return p(),E("div",Ie,[s[24]||(s[24]=u("div",null,[u("h1",{class:"text-3xl font-bold text-gray-900"}," 管理員列表 "),u("p",{class:"text-gray-600 mt-1"}," 管理後台帳號、分配權限群組、進行權限稽核 ")],-1)),l(t(Ee),{type:"info"},{default:o(()=>{var e;return[s[14]||(s[14]=g(" 當前用戶角色： ",-1)),l(t(P),{type:j(((e=t(c).user)==null?void 0:e.role)||"USER")},{default:o(()=>{var n,d;return[g(v(((n=t(c).user)==null?void 0:n.role)==="DEVELOPER"?"技術開發":((d=t(c).user)==null?void 0:d.role)==="MANAGER"?"營運主管":"一般職員"),1)]}),_:1},8,["type"])]}),_:1}),u("div",Me,[l(t(V),null,{default:o(()=>[l(t(D),{value:I.value,"onUpdate:value":s[0]||(s[0]=e=>I.value=e),type:"text",placeholder:"搜尋帳號或名稱...",clearable:"",style:{"max-width":"300px"}},{prefix:o(()=>[l(t(O),null,{default:o(()=>[l(t(se))]),_:1})]),_:1},8,["value"]),u("div",Be,[be(u("input",{type:"checkbox","onUpdate:modelValue":s[1]||(s[1]=e=>T.value=e)},null,512),[[_e,T.value]]),s[15]||(s[15]=u("label",{class:"text-sm text-gray-700"},"顯示已刪除",-1))])]),_:1}),l(t(S),{type:"primary",disabled:((i=t(c).user)==null?void 0:i.role)==="USER",onClick:ie},{icon:o(()=>[l(t(O),null,{default:o(()=>[l(t(ae))]),_:1})]),default:o(()=>[s[16]||(s[16]=g(" 新增帳號 ",-1))]),_:1},8,["disabled"])]),l(t(Z),{bordered:!1},{default:o(()=>[l(t($),{show:x.value},{default:o(()=>[u("table",Ge,[s[18]||(s[18]=u("thead",{class:"bg-gray-50"},[u("tr",null,[u("th",{class:"border border-gray-300 px-4 py-2 text-left w-28"},"管理員帳號"),u("th",{class:"border border-gray-300 px-4 py-2 text-left w-28"},"顯示名稱"),u("th",{class:"border border-gray-300 px-4 py-2 text-left w-24"},"身份階級"),u("th",{class:"border border-gray-300 px-4 py-2 text-left w-36"},"所屬群組"),u("th",{class:"border border-gray-300 px-4 py-2 text-left w-24"},"帳號狀態"),u("th",{class:"border border-gray-300 px-4 py-2 text-left w-32"},"最後登入"),u("th",{class:"border border-gray-300 px-4 py-2 text-center w-40"},"操作")])],-1)),u("tbody",null,[(p(!0),E(C,null,M(ue.value,e=>(p(),E("tr",{key:e.id,class:"border border-gray-300 hover:bg-gray-50"},[u("td",Te,[u("span",qe,v(e.username),1),e.deleted_at?(p(),E("span",je," (已刪除)")):L("",!0)]),u("td",Fe,v(e.display_name),1),u("td",We,[l(t(P),{type:j(e.role)},{default:o(()=>[g(v(e.role==="DEVELOPER"?"技術開發":e.role==="MANAGER"?"營運主管":"一般職員"),1)]),_:2},1032,["type"])]),u("td",$e,[e.groups&&e.groups.length>0?(p(),k(t(V),{key:0,size:8},{default:o(()=>[(p(!0),E(C,null,M(e.groups,n=>(p(),k(t(P),{key:n,type:"info",size:"small"},{default:o(()=>{var d;return[g(v(((d=t(G).find(y=>y.id===n))==null?void 0:d.name)||n),1)]}),_:2},1024))),128))]),_:2},1024)):(p(),E("span",Ke,"-"))]),u("td",He,[l(t(P),{type:ne(e.status)},{default:o(()=>[g(v(de(e.status)),1)]),_:2},1032,["type"])]),u("td",Ze,v(e.last_login||"-"),1),u("td",Je,[l(t(V),{justify:"center",size:8},{default:o(()=>{var n,d,y;return[l(t(S),{text:"",type:"primary",size:"small",disabled:((n=t(c).user)==null?void 0:n.role)==="USER"||!!e.deleted_at,onClick:w=>pe(e)},{icon:o(()=>[l(t(O),{size:"18"},{default:o(()=>[l(t(K))]),_:1})]),_:1},8,["disabled","onClick"]),l(t(S),{text:"",type:"info",size:"small",disabled:e.role==="DEVELOPER"&&((d=t(c).user)==null?void 0:d.role)!=="DEVELOPER",onClick:w=>ve(e)},{icon:o(()=>[l(t(O),{size:"18"},{default:o(()=>[l(t(le))]),_:1})]),_:1},8,["disabled","onClick"]),l(t(Le),{disabled:((y=t(c).user)==null?void 0:y.role)==="USER"||!!e.deleted_at,onPositiveClick:()=>fe(e)},{trigger:o(()=>{var w;return[l(t(S),{text:"",type:"error",size:"small",disabled:((w=t(c).user)==null?void 0:w.role)==="USER"},{icon:o(()=>[l(t(O),{size:"18"},{default:o(()=>[l(t(z))]),_:1})]),_:1},8,["disabled"])]}),default:o(()=>[s[17]||(s[17]=g(" 確定要刪除此帳號嗎？ ",-1))]),_:1},8,["disabled","onPositiveClick"])]}),_:2},1024)])]))),128))])]),u("div",Qe,[l(t(Ue),{page:N.page,"onUpdate:page":s[2]||(s[2]=e=>N.page=e),"page-size":N.pageSize,"page-count":Math.ceil(H.value.length/N.pageSize)},null,8,["page","page-size","page-count"])])]),_:1},8,["show"])]),_:1}),l(t(he),{show:R.value,"onUpdate:show":s[12]||(s[12]=e=>R.value=e),title:b.value?"編輯帳號":"新增帳號",preset:"dialog",size:"large"},{action:o(()=>[l(t(V),null,{default:o(()=>[l(t(S),{onClick:s[11]||(s[11]=()=>R.value=!1)},{default:o(()=>[...s[19]||(s[19]=[g("取消",-1)])]),_:1}),l(t(S),{type:"primary",loading:x.value,onClick:ce},{default:o(()=>[...s[20]||(s[20]=[g(" 保存 ",-1)])]),_:1},8,["loading"])]),_:1})]),default:o(()=>[l(t($),{show:x.value},{default:o(()=>[l(t(xe),{ref:"accountFormRef",model:a,"label-placement":"top","label-width":"auto"},{default:o(()=>[l(t(h),{label:"管理員帳號",path:"username",required:""},{default:o(()=>[l(t(D),{value:a.username,"onUpdate:value":s[3]||(s[3]=e=>a.username=e),placeholder:"請輸入帳號",disabled:!!b.value},null,8,["value","disabled"])]),_:1}),l(t(h),{label:"顯示名稱",path:"display_name",required:""},{default:o(()=>[l(t(D),{value:a.display_name,"onUpdate:value":s[4]||(s[4]=e=>a.display_name=e),placeholder:"請輸入顯示名稱 (2-20 字)",maxlength:"20"},null,8,["value"])]),_:1}),l(t(h),{label:"身份階級",path:"role",required:""},{default:o(()=>{var e;return[l(t(Y),{value:a.role,"onUpdate:value":s[5]||(s[5]=n=>a.role=n),options:re.value,disabled:((e=t(c).user)==null?void 0:e.role)==="USER"},null,8,["value","options","disabled"])]}),_:1}),a.role==="USER"?(p(),k(t(h),{key:0,label:"所屬群組",path:"groups",required:""},{default:o(()=>[l(t(we),{value:a.groups,"onUpdate:value":s[6]||(s[6]=e=>a.groups=e)},{default:o(()=>[l(t(V),{vertical:""},{default:o(()=>[(p(!0),E(C,null,M(oe.value,e=>(p(),k(t(Ne),{key:e.id,value:e.id,label:e.name,disabled:!b.value&&t(W).some(n=>{var d,y;return n.id===((d=t(c).user)==null?void 0:d.user_id)&&((y=n.groups)==null?void 0:y.includes(e.id))})===!1},null,8,["value","label","disabled"]))),128))]),_:1})]),_:1},8,["value"])]),_:1})):L("",!0),b.value?L("",!0):(p(),E(C,{key:1},[l(t(h),{label:"登入密碼",path:"password",required:""},{default:o(()=>[l(t(D),{value:a.password,"onUpdate:value":s[7]||(s[7]=e=>a.password=e),type:"password",placeholder:"6-16 位元英數字","show-password-on":"click"},null,8,["value"])]),_:1}),l(t(h),{label:"確認密碼",path:"confirmPassword",required:""},{default:o(()=>[l(t(D),{value:a.confirmPassword,"onUpdate:value":s[8]||(s[8]=e=>a.confirmPassword=e),type:"password",placeholder:"請再次輸入密碼","show-password-on":"click"},null,8,["value"])]),_:1})],64)),l(t(h),{label:"帳號狀態",path:"status",required:""},{default:o(()=>[l(t(Y),{value:a.status,"onUpdate:value":s[9]||(s[9]=e=>a.status=e),options:[{label:"啟用",value:"ENABLED"},{label:"停用",value:"DISABLED"},{label:"鎖定",value:"LOCKED"}]},null,8,["value"])]),_:1}),b.value?(p(),k(t(h),{key:2,label:"異動原因",path:"reason",required:""},{default:o(()=>[l(t(D),{value:a.reason,"onUpdate:value":s[10]||(s[10]=e=>a.reason=e),type:"textarea",placeholder:"請輸入此次修改的原因",maxlength:"200",rows:2},null,8,["value"])]),_:1})):L("",!0)]),_:1},8,["model"])]),_:1},8,["show"])]),_:1},8,["show","title"]),l(t(Oe),{show:q.value,"onUpdate:show":s[13]||(s[13]=e=>q.value=e),title:"權限稽核",width:"600",placement:"right"},{default:o(()=>[f.value?(p(),k(t(Ce),{key:0},{default:o(()=>[l(t($),{show:x.value},{default:o(()=>[l(t(Ae),{cols:1,responsive:"screen","x-gap":12,"y-gap":16},{default:o(()=>[l(t(J),null,{default:o(()=>[u("div",Xe,[u("p",null,[s[21]||(s[21]=u("span",{class:"font-semibold"},"帳號：",-1)),g(" "+v(f.value.username),1)]),u("p",null,[s[22]||(s[22]=u("span",{class:"font-semibold"},"名稱：",-1)),g(" "+v(f.value.display_name),1)]),u("p",null,[s[23]||(s[23]=u("span",{class:"font-semibold"},"身份：",-1)),l(t(P),{type:j(f.value.role)},{default:o(()=>[g(v(f.value.role==="DEVELOPER"?"技術開發":f.value.role==="MANAGER"?"營運主管":"一般職員"),1)]),_:1},8,["type"])])])]),_:1}),l(t(J),null,{default:o(()=>[l(t(Z),{title:"生效權限清單",size:"small"},{default:o(()=>[u("div",Ye,[(p(!0),E(C,null,M(t(F),e=>{var n;return p(),E("div",{key:e.code,class:"p-3 border rounded bg-gray-50 hover:bg-blue-50"},[u("div",et,[u("div",null,[u("p",tt,v(e.code),1),u("p",st,v(e.name),1)]),u("div",at,[l(t(P),{type:U(f.value)[e.code]==="WRITE"?"success":U(f.value)[e.code]==="READ"?"warning":"default"},{default:o(()=>[g(v(U(f.value)[e.code]==="WRITE"?"操作":U(f.value)[e.code]==="READ"?"唯讀":"無"),1)]),_:2},1032,["type"]),f.value.role!=="DEVELOPER"&&U(f.value)[e.code]!=="NONE"?(p(),E("p",lt," 來源："+v((n=f.value.groups)==null?void 0:n.map(d=>{var y;return(y=t(G).find(w=>w.id===d))==null?void 0:y.name}).join(", ")),1)):f.value.role==="DEVELOPER"?(p(),E("p",rt," 來源：系統預設全域權限 ")):L("",!0)])])])}),128))])]),_:1})]),_:1})]),_:1})]),_:1},8,["show"])]),_:1})):L("",!0)]),_:1},8,["show"])])}}}),wt=Re(ot,[["__scopeId","data-v-d2bf892d"]]);export{wt as default};
