import{e as V,P as $,o as R,v as I,E as i,D as d,F as n,w as M,K as v,J as E,G as H,W as J,Q as F,Y as W,Z as y,$ as f,a1 as T,r as b,j as A,a0 as Q,s as G,h as m}from"./index-BsKuKuBe.js";import{C as Z}from"./CreateOutline-CbXbgX50.js";import{N as X}from"./DataTable-D5mRR0cm.js";import{N as q}from"./Icon-CbayTH31.js";import{N as ee}from"./Select-CCDzjsmj.js";import{N as U}from"./Switch-DXNn_bI_.js";import{N as te}from"./Tag-I3_cH6qL.js";import{N as ae}from"./Space-Cf9Hs1lp.js";import"./Radio-C5fS5KPL.js";import"./RadioGroup-CgIVku-C.js";import"./Tooltip-XZFA5Owl.js";import"./Popover-CfBNgOAF.js";import"./use-compitable-BjMNwQgq.js";import"./Dropdown-CcmdnIk3.js";import"./create-Bj8PAPmY.js";import"./use-keyboard-kkRvbDTj.js";import"./create-ref-setter-C4J8sofl.js";import"./Empty-DtuLCoXR.js";import"./Pagination-BLbp2o8H.js";import"./Forward-CBwL8ab_.js";const k=()=>new Date().toISOString(),g=()=>new Date(Date.now()-7*24*60*60*1e3).toISOString(),h=[{id:"K1",category:"GAME",provider:"PG Soft",endpoint:"https://staging.pg.example.com/api",merchant_id:"MERC_PG_001",api_key:"PUBKEY_PG_STAGING",secret_key_encrypted:"encrypted_dummy_pg",secret_masked:"****0123",ip_whitelist:"1.2.3.4, 5.6.7.8",enabled:!0,created_at:g(),updated_at:k()},{id:"K2",category:"GAME",provider:"PG Soft",endpoint:"https://api.pg.example.com/api",merchant_id:"MERC_PG_PROD",api_key:"PUBKEY_PG_PROD",secret_key_encrypted:"encrypted_prod_pg",secret_masked:"****5678",ip_whitelist:"10.0.0.0/8",enabled:!0,error:"連線逾時 (Connection Timeout)",created_at:g(),updated_at:k()},{id:"K3",category:"GAME",provider:"JILI",endpoint:"https://test.jili.example.com/api",merchant_id:"MERC_JILI_001",api_key:"JILI_KEY_TEST",secret_key_encrypted:"encrypted_jili_test",secret_masked:"****9999",ip_whitelist:"1.1.1.0/24",enabled:!0,created_at:g(),updated_at:k()},{id:"K4",category:"PAYMENT",provider:"綠界科技 (ECPay)",endpoint:"https://payment-stage.ecpay.com.tw/Cweb/CreateMerchantTradeOrder",merchant_id:"ECPAY_MERC_TEST",api_key:"ECPAY_HASHIV_TEST",secret_key_encrypted:"encrypted_ecpay_hashkey",secret_masked:"****aaaa",ip_whitelist:"",enabled:!0,error:"Merchant ID 無效",created_at:g(),updated_at:k()},{id:"K5",category:"PAYMENT",provider:"Stripe",endpoint:"https://api.stripe.com/v1",merchant_id:"acct_1234567890",api_key:"pk_test_123456789",secret_key_encrypted:"encrypted_stripe_secret",secret_masked:"****zzzz",ip_whitelist:"",enabled:!1,created_at:g(),updated_at:k()},{id:"K6",category:"SMS",provider:"Twilio",endpoint:"https://api.twilio.com/2010-4-01",merchant_id:"AC12345678901234567890",api_key:"TWILIO_ACCOUNT_SID",secret_key_encrypted:"encrypted_twilio_token",secret_masked:"****xxxx",ip_whitelist:"",enabled:!0,created_at:g(),updated_at:k()},{id:"K7",category:"AUTH",provider:"Google Authenticator",endpoint:"https://accounts.google.com/o/oauth2/auth",merchant_id:"GOOGLE_CLIENT_ID",api_key:"GOOGLE_CLIENT_SECRET",secret_key_encrypted:"encrypted_google_oauth",secret_masked:"****yyyy",ip_whitelist:"127.0.0.1",enabled:!0,created_at:g(),updated_at:k()}],P=(o=300)=>new Promise(s=>setTimeout(s,o)),D=o=>{if(o)return"****"+o.slice(-4)},x={async list(){return await P(),{code:0,msg:"success",data:h}},async get(o){await P();const s=h.find(u=>u.id===o);return s?{code:0,msg:"success",data:s}:{code:404,msg:"Not found"}},async create(o){await P();const s=`K${Math.floor(Math.random()*1e5)}`,u=new Date().toISOString(),l={id:s,category:o.category,provider:o.provider,endpoint:o.endpoint,merchant_id:o.merchant_id,api_key:o.api_key,secret_key_encrypted:o.secret_key?`enc(${o.secret_key})`:void 0,secret_masked:D(o.secret_key),ip_whitelist:o.ip_whitelist,proxy:o.proxy,enabled:o.enabled===void 0?!0:o.enabled,created_at:u};return h.unshift(l),{code:0,msg:"success",data:l}},async update(o,s){await P();const u=h.findIndex(p=>p.id===o);if(u===-1)return{code:404,msg:"Not found"};const l=h[u];return h[u]={...l,...s,secret_key_encrypted:s.secret_key?`enc(${s.secret_key})`:l.secret_key_encrypted,secret_masked:s.secret_key?D(s.secret_key):l.secret_masked,updated_at:new Date().toISOString()},{code:0,msg:"success"}},async testConnection(o,s=5e3){new AbortController;const u=new Promise(async p=>{let _="";if(typeof o=="string"){const C=h.find(w=>w.id===o);if(!C)return p({code:404,msg:"Not found"});_=C.endpoint}else _=o.endpoint;const c=Math.min(800,Math.random()*1200);return await P(c),_.includes("unauthorized")?p({code:401,msg:"Unauthorized",data:{ok:!1,code:"401"}}):p({code:0,msg:"success",data:{ok:!0}})}),l=new Promise(p=>setTimeout(()=>p({code:408,msg:"timeout"}),s));return Promise.race([u,l])}},ie={class:"p-6"},ne={class:"flex gap-2"},re={key:0,class:"ml-1"},oe={class:"flex justify-end gap-2"},Se=V({__name:"ThirdPartyKeys",setup(o){const s=$(),u=b([]),l=b(!1),p=b(!1),_=b(null),c=b({}),C=A(()=>Object.keys(c.value).length>0),w=b(!1),r=Q({category:"GAME",provider:"",endpoint:"",merchant_id:"",api_key:"",secret_key:void 0,ip_whitelist:void 0,proxy:void 0,enabled:!0}),K=[{label:"遊戲",value:"GAME"},{label:"金流",value:"PAYMENT"},{label:"簡訊",value:"SMS"},{label:"驗證",value:"AUTH"}],S=async()=>{l.value=!0,c.value={};const t=await x.list();t.code===0&&(u.value=t.data||[]),l.value=!1},O=A(()=>[{title:"供應商",key:"provider",width:150,render:t=>t.provider},{title:"類別",key:"category",width:100,render:t=>m(te,{type:"info"},{default:()=>t.category})},{title:"端點",key:"endpoint",width:250,render:t=>m("span",{class:"text-xs text-gray-600"},t.endpoint)},{title:"Proxy",key:"proxy",width:150,render:t=>t.proxy||"-"},{title:"Merchant ID",key:"merchant_id",width:150,render:t=>t.merchant_id},{title:"異常",key:"error",width:200,render:t=>t.error?m("span",{class:"text-red-500 text-xs font-bold"},t.error):m("span",{class:"text-gray-400 text-xs"},"-")},{title:"狀態",key:"enabled",width:100,render:t=>{const e=c.value[t.id]!==void 0?c.value[t.id]:t.enabled;return m(U,{value:e,onUpdateValue:a=>L(t,a)})}},{title:"操作",key:"actions",width:200,align:"center",render:t=>m(ae,{},{default:()=>[m(v,{size:"small",type:"primary",onClick:()=>N(t)},{default:()=>"測試連線"}),m(v,{size:"small",onClick:()=>z(t)},{default:()=>"編輯"})]})}]),j=()=>{_.value=null,Object.assign(r,{category:"GAME",provider:"",endpoint:"",merchant_id:"",api_key:"",secret_key:void 0,ip_whitelist:void 0,proxy:void 0,enabled:!0}),p.value=!0},z=t=>{_.value=t,Object.assign(r,{category:t.category,provider:t.provider,endpoint:t.endpoint,merchant_id:t.merchant_id,api_key:t.api_key,secret_key:void 0,ip_whitelist:t.ip_whitelist,proxy:t.proxy,enabled:t.enabled}),p.value=!0},Y=async()=>{if(!r.provider||!r.endpoint||!r.merchant_id||!r.api_key){s.warning("請填寫必要欄位");return}_.value?(await x.update(_.value.id,r),s.success("已更新")):(await x.create(r),s.success("已新增")),p.value=!1,S()},L=(t,e)=>{t.enabled===e?delete c.value[t.id]:c.value[t.id]=e},B=async()=>{l.value=!0;try{const t=Object.entries(c.value).map(([e,a])=>x.update(e,{enabled:a}));await Promise.all(t),s.success("存取成功"),w.value=!1,S()}catch{s.error("存取失敗")}finally{l.value=!1}},N=async t=>{var a;s.info("測試中...");const e=t?await x.testConnection(t.id):await x.testConnection(r);e.code===0&&((a=e.data)!=null&&a.ok)?s.success("驗證成功"):e.code===401?s.error("Unauthorized (401)"):e.code===408?s.error("連線逾時，請檢查端點或 IP 白名單"):s.error(e.msg||"驗證失敗")};return R(S),(t,e)=>(G(),I("div",ie,[i(n(F),{title:"第三方 Key 管理",class:"mb-4"},{"header-extra":d(()=>[M("div",ne,[i(n(v),{type:"warning",disabled:!C.value,onClick:e[0]||(e[0]=a=>w.value=!0),loading:l.value},{icon:d(()=>[i(n(q),null,{default:d(()=>[i(n(Z))]),_:1})]),default:d(()=>[e[14]||(e[14]=E(" 存取操作 ",-1)),C.value?(G(),I("span",re,"("+H(Object.keys(c.value).length)+")",1)):J("",!0)]),_:1},8,["disabled","loading"]),i(n(v),{type:"primary",onClick:j},{default:d(()=>[...e[15]||(e[15]=[E("新增金鑰",-1)])]),_:1})])]),default:d(()=>[i(n(X),{columns:O.value,data:u.value,loading:l.value,bordered:!1,"single-line":!1},null,8,["columns","data","loading"])]),_:1}),i(n(T),{show:p.value,"onUpdate:show":e[12]||(e[12]=a=>p.value=a),title:"金鑰設定",preset:"card",style:{width:"640px"}},{footer:d(()=>[M("div",oe,[i(n(v),{onClick:e[10]||(e[10]=a=>p.value=!1)},{default:d(()=>[...e[16]||(e[16]=[E("取消",-1)])]),_:1}),i(n(v),{onClick:e[11]||(e[11]=()=>N())},{default:d(()=>[...e[17]||(e[17]=[E("測試連線",-1)])]),_:1}),i(n(v),{type:"primary",onClick:Y},{default:d(()=>[...e[18]||(e[18]=[E("儲存",-1)])]),_:1})])]),default:d(()=>[i(n(W),{model:r},{default:d(()=>[i(n(y),{label:"對接類別"},{default:d(()=>[i(n(ee),{value:r.category,"onUpdate:value":e[1]||(e[1]=a=>r.category=a),options:K},null,8,["value"])]),_:1}),i(n(y),{label:"供應商名稱",required:""},{default:d(()=>[i(n(f),{value:r.provider,"onUpdate:value":e[2]||(e[2]=a=>r.provider=a)},null,8,["value"])]),_:1}),i(n(y),{label:"API 端點 (Endpoint)",required:""},{default:d(()=>[i(n(f),{value:r.endpoint,"onUpdate:value":e[3]||(e[3]=a=>r.endpoint=a)},null,8,["value"])]),_:1}),i(n(y),{label:"Merchant ID",required:""},{default:d(()=>[i(n(f),{value:r.merchant_id,"onUpdate:value":e[4]||(e[4]=a=>r.merchant_id=a)},null,8,["value"])]),_:1}),i(n(y),{label:"API Key / App ID",required:""},{default:d(()=>[i(n(f),{value:r.api_key,"onUpdate:value":e[5]||(e[5]=a=>r.api_key=a)},null,8,["value"])]),_:1}),i(n(y),{label:"Secret Key"},{default:d(()=>[i(n(f),{value:r.secret_key,"onUpdate:value":e[6]||(e[6]=a=>r.secret_key=a),type:"password","show-password-on":"click"},null,8,["value"])]),_:1}),i(n(y),{label:"IP 白名單"},{default:d(()=>[i(n(f),{value:r.ip_whitelist,"onUpdate:value":e[7]||(e[7]=a=>r.ip_whitelist=a),type:"textarea",placeholder:"以逗號分隔"},null,8,["value"])]),_:1}),i(n(y),{label:"Proxy"},{default:d(()=>[i(n(f),{value:r.proxy,"onUpdate:value":e[8]||(e[8]=a=>r.proxy=a),placeholder:"http://proxy-server:port (可選)"},null,8,["value"])]),_:1}),i(n(y),{label:"當前狀態"},{default:d(()=>[i(n(U),{value:r.enabled,"onUpdate:value":e[9]||(e[9]=a=>r.enabled=a)},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["show"]),i(n(T),{show:w.value,"onUpdate:show":e[13]||(e[13]=a=>w.value=a),preset:"dialog",type:"warning",title:"警告",content:"確定要存取狀態變更？","positive-text":"確認","negative-text":"取消",onPositiveClick:B},null,8,["show"])]))}});export{Se as default};
